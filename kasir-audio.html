<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kasir Kelma - Belajar Uang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      :root {
        --primary-bg: #fef3c7;
        --accent-green: #38a169;
        --accent-yellow: #f6ad55;
      }
      body {
        font-family: "Poppins", sans-serif;
        background: #fff7ed;
        margin: 5px;
        display: flex;
        justify-content: center;
        align-items: flex-start;

        padding: 20px;
      }
      .kasir-container {
        background: #fff;
        border-radius: 20px;
        max-width: 900px;
        width: 100%;
        overflow: hidden;
        display: grid;
        grid-template-rows: auto 1fr;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }
      .header-scene {
        background-color: #fabb58;
        color: white;
        padding: 20px;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        text-align: center;
        position: relative;
        overflow: hidden;
        height: 160px;
      }
      @keyframes moveBackground {
        0% {
          background-position: 0 0;
        }
        100% {
          background-position: -600px 0;
        }
      }
      .header-scene::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-repeat: repeat-x;
        background-size: auto 100%;
        background-position: 0 0;
        animation: moveBackground 25s linear infinite;
        opacity: 0.5;
        z-index: 0;
      }
      .scene-content {
        position: relative;
        z-index: 2;
        text-align: center;
      }
      .cashier-img {
        background-image: url("https://placehold.co/80x80/ffffff/000000?text=K A S I R%0AK E L M A&font-size=20");
        background-size: cover;
        border-radius: 50%;
        border: 4px solid #fff;
        width: 110px;
        height: 110px;
        margin: 0 auto 10px;
      }
      .moving-items {
        position: absolute;
        top: 40%;
        left: 0;
        width: 200vw;
        display: flex;
        z-index: 1;
        animation: moveItems 20s linear infinite;
      }
      .moving-item {
        width: 100vw;
        height: auto;
        object-fit: cover;
        transform: translateY(-50%);
      }
      @keyframes moveItems {
        0% {
          transform: translateX(0);
        }
        100% {
          transform: translateX(-100vw);
        }
      }
      #moneyButtons {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
      }
      @media (max-width: 768px) {
        #moneyButtons {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .title {
        font-size: 28px;
        font-weight: 800;
        color: #ff7b00;
        margin-bottom: 10px;
        text-align: center; /* <-- ini menengahkan teks */
      }

      /* Tombol Pilih Jajan */
      .action-btn {
        background: #fbbf24; /* kuning cerah */
        color: #ffffff; /* teks gelap agar kontras */
        font-weight: 700;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px; /* spasi antara teks & loading */
        padding: 15px;
        border-radius: 15px;
        border: none;
        cursor: pointer;
        transition: transform 0.15s ease, background 0.2s ease;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

      .action-btn:hover {
        background: #fcd34d; /* lebih terang saat hover */
        transform: translateY(-2px);
      }

      .action-btn:active {
        transform: translateY(1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .start-container {
        display: inline-block;
      }

      .loading-spinner {
        /* border: 3px solid rgba(255, 255, 255, 0.3); */ /* hapus ini */
        border-top: 3px solid #1a202c; /* warna garis spinner */
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }

      .loading-spinner.hidden {
        display: none;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .money-btn img {
        width: 100%;
        height: 100px;
        object-fit: contain;
        border-radius: 8px;
      }
      #messageBox {
        padding: 10px;
        margin-top: 10px;
        border-radius: 10px;
        font-weight: bold;
        text-align: center;
      }
      .back-btn {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.85);
        color: #ea580c;
        font-weight: bold;
        padding: 8px 14px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        border: none;
        cursor: pointer;
        z-index: 9999;
        transition: 0.2s;
      }
      .back-btn:hover {
        background: white;
        transform: scale(1.05);
      }
      #scrollTopBtn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 45px;
        height: 45px;
        background: #ea580c;
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 22px;
        font-weight: bold;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
        z-index: 9999;
        transition: 0.3s ease;
      }
      #scrollTopBtn:hover {
        background: #c2410c;
      }
    </style>
  </head>
  <body>
    <div class="kasir-container">
      <button id="btnBack" class="back-btn">
        <i class="fas fa-arrow-left"></i>
      </button>
      <header class="header-scene" id="headerScene">
        <div class="scene-content"><div class="cashier-img"></div></div>
        <div class="moving-items">
          <img src="img/header.jpg" alt="header" class="moving-item" />
          <img src="img/header.jpg" alt="header" class="moving-item" />
        </div>
      </header>
      <main class="p-6">
        <h1 class="title">Kasir Kelma üç±‚ú®</h1>
        <button
          id="btnPlus"
          class="action-btn btn-plus w-full p-4 mb-3 rounded-xl flex items-center justify-center"
        >
          <span id="plusText">Pilih Jajan ‚ú®</span>
          <div id="plusLoading" class="loading-spinner hidden ml-2"></div>
        </button>
        <!-- Tambahkan class hidden ke semua elemen yang muncul step berikutnya -->
        <div
          id="itemGambarDisplay"
          class="w-full h-40 mb-3 bg-gray-100 flex items-center justify-center rounded-lg overflow-hidden hidden"
        ></div>
        <div
          id="itemNameDisplay"
          class="text-2xl font-bold text-center mb-4 hidden"
        ></div>
        <div
          id="itemPriceDisplay"
          class="flex items-center justify-center gap-3 mb-4 hidden"
        ></div>
        <div
          class="flex items-center justify-center gap-3 mb-4 hidden"
          id="quantityControls"
        >
          <button
            id="btnQuantityMinus"
            class="bg-red-500 w-10 h-10 text-white rounded-full disabled:opacity-50"
            disabled
          >
            -
          </button>
          <span
            id="quantityDisplay"
            class="text-3xl font-extrabold w-10 text-center"
            >0</span
          >
          <button
            id="btnQuantityPlus"
            class="bg-green-500 w-10 h-10 text-white rounded-full disabled:opacity-50"
            disabled
          >
            +
          </button>
        </div>
        <button
          id="btnProceedPayment"
          disabled
          class="bg-blue-500 text-white p-3 rounded-lg w-full mb-4 hidden"
        >
          Lanjut ke Bayar
        </button>
        <div id="moneyButtons" class="hidden"></div>

        <div id="messageBox" class="hidden"></div>
      </main>
    </div>
    <button id="scrollTopBtn">‚Üë</button>

    <script>
      const itemNameDisplay = document.getElementById("itemNameDisplay");
      const itemGambarDisplay = document.getElementById("itemGambarDisplay");
      const itemPriceDisplay = document.getElementById("itemPriceDisplay");
      const quantityDisplay = document.getElementById("quantityDisplay");
      const btnQuantityPlus = document.getElementById("btnQuantityPlus");
      const btnQuantityMinus = document.getElementById("btnQuantityMinus");
      const btnPlus = document.getElementById("btnPlus");
      const plusText = document.getElementById("plusText");
      const plusLoading = document.getElementById("plusLoading");
      const moneyButtonsContainer = document.getElementById("moneyButtons");
      const messageBox = document.getElementById("messageBox");
      const scrollTopBtn = document.getElementById("scrollTopBtn");
      const mode = localStorage.getItem("gameMode") || "audio";

      let basePrice = 0,
        itemQuantity = 0,
        itemPrice = 0,
        totalPaid = 0;
      const priceList = {
        "Ayam Goreng": 12000,
        Bakso: 10000,
        Batagor: 8000,
        "Bubur Ayam": 10000,
        Cilok: 5000,
        Cimol: 5000,
        Dimsum: 10000,
        Donat: 5000,
        "Es Buah": 8000,
        "Es Jeruk": 5000,
        "Es Krim": 6000,
        "Es Teh": 4000,
        "Es Teler": 10000,
        Jus: 7000,
        Kwetiau: 15000,
        Maklor: 5000,
        "Martabak Manis": 12000,
        "Martabak Telur": 15000,
        "Mie Ayam": 15000,
        Mineral: 3000,
        Nasgor: 15000,
        "Pecel Lele": 15000,
        "Risol Mayo": 6000,
        "Roti Bakar": 10000,
        Seblak: 8000,
        Somay: 8000,
        Soto: 12000,
        Takoyaki: 10000,
        "Telur Gulung": 3000,
        "Telur Puyuh": 4000,
      };
      const itemImages = {
        "Ayam Goreng": "img/menu/ayam_goreng.jpg",
        Bakso: "img/menu/bakso.jpeg",
        Batagor: "img/menu/batagor.jpg",
        "Bubur Ayam": "img/menu/bubur_ayam.jpeg",
        Cilok: "img/menu/cilok.jpeg",
        Cimol: "img/menu/cimol.jpeg",
        Dimsum: "img/menu/dimsum.jpeg",
        Donat: "img/menu/donat.jpeg",
        "Es Buah": "img/menu/es_buah.jpg",
        "Es Jeruk": "img/menu/es_jeruk.jpeg",
        "Es Krim": "img/menu/es_krim.jpeg",
        "Es Teh": "img/menu/es_teh.jpeg",
        "Es Teler": "img/menu/es_teler.jpeg",
        Jus: "img/menu/jus.jpeg",
        Kwetiau: "img/menu/kwetiau.jpeg",
        Maklor: "img/menu/maklor.jpeg",
        "Martabak Manis": "img/menu/martabak_manis.jpeg",
        "Martabak Telur": "img/menu/martabak_telur.jpeg",
        "Mie Ayam": "img/menu/mie_ayam.jpeg",
        Mineral: "img/menu/mineral.jpg",
        Nasgor: "img/menu/nasgor.jpeg",
        "Pecel Lele": "img/menu/pecel_lele.jpeg",
        "Risol Mayo": "img/menu/risol_mayo.jpeg",
        "Roti Bakar": "img/menu/roti_bakar.jpeg",
        Seblak: "img/menu/seblak.jpeg",
        Somay: "img/menu/somay.jpeg",
        Soto: "img/menu/soto.jpeg",
        Takoyaki: "img/menu/takoyaki.jpeg",
        "Telur Gulung": "img/menu/telur_gulung.jpeg",
        "Telur Puyuh": "img/menu/telur_puyuh.jpg",
      };
      const denominations = [
        100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000,
      ];
      const heroData = {
        100: { name: "Koin 100", img: "img/100.png" },
        200: { name: "Koin 200", img: "img/200.png" },
        500: { name: "Koin 500", img: "img/500.png" },
        1000: { name: "1 Ribu", img: "img/1000.png" },
        2000: { name: "2 Ribu", img: "img/2000.png" },
        5000: { name: "5 Ribu", img: "img/5000.png" },
        10000: { name: "10 Ribu", img: "img/10000.png" },
        20000: { name: "20 Ribu", img: "img/20000.png" },
        50000: { name: "50 Ribu", img: "img/50000.png" },
        100000: { name: "100 Ribu", img: "img/100000.png" },
      };

      function formatRupiah(n) {
        return new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
          minimumFractionDigits: 0,
        }).format(n);
      }
      function playVerbalFeedback(msg) {
        if (!msg) return;
        window.speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(msg);
        utter.lang = "id-ID";
        window.speechSynthesis.speak(utter);
      }
      function updateDisplay() {
        itemPriceDisplay.textContent = formatRupiah(itemPrice);
        quantityDisplay.textContent = itemQuantity;
        messageBox.classList.add("hidden");
      }
      function recalc() {
        itemPrice = basePrice * itemQuantity;
        updateDisplay();
      }

      // ===== Tombol Pilih Jajan =====
      // Aktifkan Enter untuk Pilih Jajan sekali saja
      btnPlus.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          btnPlus.click();
        }
      });

      // Listener click tunggal
      let menuAktif = false;

      function loadMenuLoop() {
        const keys = Object.keys(priceList);
        const randomName = keys[Math.floor(Math.random() * keys.length)];
        basePrice = priceList[randomName];
        itemQuantity = 1;
        totalPaid = 0;
        recalc();

        itemNameDisplay.textContent = randomName;
        itemGambarDisplay.innerHTML = `<img src="${itemImages[randomName]}" class="w-full h-full object-contain"/>`;

        itemGambarDisplay.classList.remove("hidden");
        itemNameDisplay.classList.remove("hidden");
        itemPriceDisplay.classList.remove("hidden");
        document.getElementById("quantityControls").classList.remove("hidden");
        btnProceedPayment.classList.remove("hidden");
        btnProceedPayment.disabled = false;

        // üîπ tandai menu aktif supaya keyboard +- berfungsi
        menuAktif = true;

        playVerbalFeedback(
          `Menu baru: ${randomName}. Harganya ${formatRupiah(
            basePrice
          )}. Tekan enter untuk memilih menu jajanan lainya. Tekan tanda tambah di keyboard untuk menambah banyak item. Tekan tanda kurang di keyboard untuk mengurangi banyak item.     kalau sudah selesai, bisa tekan tab untuk masuk ke menu lanjut ke pembayaran `
        );
      }
      // scroll setelah header
      function scrollToAfterHeader() {
        const header = document.querySelector(".header-scene");
        if (!header) return;

        const y = header.offsetHeight;
        window.scrollTo({
          top: y,
          behavior: "smooth",
        });
      }

      // Tekan Enter ‚Üí pilih menu baru
      btnPlus.addEventListener("click", () => {
        loadMenuLoop(); // logic pilih menu
        scrollToAfterHeader(); // ‚úÖ scroll otomatis
      });
      btnPlus.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          loadMenuLoop();
        }
      });

      // ===== Tombol Kuantitas =====
      document.addEventListener("keydown", (e) => {
        if (!menuAktif) return; // pakai flag menuAktif
        if (e.key === "+" || e.key === "=") {
          if (itemQuantity < 99) itemQuantity++;
          recalc();
          playVerbalFeedback(
            `Jumlah sekarang, ${itemQuantity} item, Silakan tekan tab untuk masuk ke menu lanjutkan pembayaran.`
          );
        }
        if (e.key === "-") {
          if (itemQuantity > 1) itemQuantity--;
          recalc();
          playVerbalFeedback(
            `Jumlah sekarang, ${itemQuantity} item, Silakan tekan tab untuk masuk ke menu lanjutkan pembayaran.`
          );
        }
      });

      const btnProceedPayment = document.getElementById("btnProceedPayment");

      btnProceedPayment.addEventListener("click", () => {
        moneyButtonsContainer.classList.remove("hidden");
        moneyButtonsContainer.innerHTML = ""; // Kosongkan dulu

        denominations.forEach((value) => {
          const btn = document.createElement("button");
          const data = heroData[value];
          btn.innerHTML = `<img src="${data.img}" alt="${data.name}"/>
                     <span style="font-size:0.7rem;display:block;text-align:center;">${data.name}</span>`;
          btn.classList.add("money-btn");

          // Tambahkan klik
          btn.addEventListener("click", () => {
            totalPaid += value;
            const remaining = itemPrice - totalPaid;
            if (remaining > 0) {
              playVerbalFeedback(
                `Kamu memasukkan ${formatRupiah(
                  value
                )}. Sisa bayar ${formatRupiah(remaining)}.`
              );
            } else {
              const change = Math.abs(remaining);
              playVerbalFeedback(
                `Kamu membayar ${formatRupiah(totalPaid)}. ${
                  change > 0 ? `Kembalian ${formatRupiah(change)}.` : ""
                } Transaksi selesai!, Tekan pilih jajan untuk memulai lagi, Tekan backspace untuk kembali ke menu awal`
              );
              setTimeout(() => {
                startGame(); // Reset game
              }, 1500);
            }
          });

          // üîπ Tambahkan suara saat fokus
          btn.addEventListener("focus", () => {
            playVerbalFeedback(`Ini ${data.name}. Tekan Enter untuk memilih.`);
          });

          moneyButtonsContainer.appendChild(btn);
        });

        // Fokus tombol pertama
        const firstMoneyBtn = moneyButtonsContainer.querySelector("button");
        if (firstMoneyBtn) firstMoneyBtn.focus();
      });

      // Index tombol uang yang sedang fokus
      let currentMoneyIndex = 0;

      function focusMoneyBtn(index) {
        const buttons = moneyButtonsContainer.querySelectorAll("button");
        if (buttons.length === 0) return;
        if (index < 0) index = 0;
        if (index >= buttons.length) index = buttons.length - 1;
        currentMoneyIndex = index;
        buttons[currentMoneyIndex].focus();
      }

      // Listener global untuk ArrowLeft, ArrowRight, Enter
      document.addEventListener("keydown", (e) => {
        const buttons = moneyButtonsContainer.querySelectorAll("button");
        if (buttons.length === 0) return;

        if (document.activeElement.closest("#moneyButtons")) {
          if (e.key === "ArrowRight") {
            e.preventDefault();
            focusMoneyBtn(currentMoneyIndex + 1);
          }
          if (e.key === "ArrowLeft") {
            e.preventDefault();
            focusMoneyBtn(currentMoneyIndex - 1);
          }
          if (e.key === "Enter") {
            e.preventDefault();
            buttons[currentMoneyIndex].click();
          }
        }
      });

      // Keyboard: tekan Tab dari quantityDisplay ‚Üí fokus ke Lanjut ke Bayar
      quantityDisplay.addEventListener("keydown", (e) => {
        if (e.key === "Tab" && !btnProceedPayment.disabled) {
          e.preventDefault(); // cegah default tab
          btnProceedPayment.focus(); // fokus ke tombol Lanjut
          playVerbalFeedback(
            "Tombol lanjut ke pembayaran. Tekan Enter untuk melanjutkan."
          );
        }
      });
      btnProceedPayment.addEventListener("focus", () => {
        playVerbalFeedback(
          "Tombol lanjut ke pembayaran. Tekan Enter untuk melanjutkan."
        );
      });

      // scroll ke pembayaran
      function scrollToAftertbnbayar() {
        const header = document.querySelector(".header-scene");
        if (!header) return;

        const y = header.offsetHeight;
        window.scrollTo({
          top: y,
          behavior: "smooth",
        });
      }
      // ===== Fokus Tab Awal =====
      function setMoneyButtonsTabIndex() {
        btnPlus.setAttribute("tabindex", "0");
        btnPlus.focus();
        quantityDisplay.setAttribute("tabindex", "1");
        moneyButtonsContainer
          .querySelectorAll("button")
          .forEach((b) => b.setAttribute("tabindex", "2"));
        scrollTopBtn.setAttribute("tabindex", "99");
      }

      // ===== Fokus Tab Setelah Menu Dipilih =====
      function setMoneyButtonsTabIndexAfterMenu() {
        btnPlus.setAttribute("tabindex", "0"); // Pilih Jajan
        // Hapus tabindex quantityDisplay
        quantityDisplay.removeAttribute("tabindex");
        // Hapus tombol plus/minus dari tab
        btnQuantityMinus.setAttribute("tabindex", "-1");
        btnQuantityPlus.setAttribute("tabindex", "-1");

        // Tombol uang fokusable setelah Pilih Jajan
        moneyButtonsContainer
          .querySelectorAll("button")
          .forEach((b, i) => b.setAttribute("tabindex", 1 + i));

        scrollTopBtn.setAttribute("tabindex", 99); // tombol scroll/restart
      }

      // ===== Inisialisasi Awal =====
      window.addEventListener("load", () => {
        playVerbalFeedback(
          "Selamat datang di Game Kasir Kelma! Untuk memulai tekan enter untuk memilih menu jajanan."
        );
        setMoneyButtonsTabIndex();
      });

      // ===== Tombol Scroll Top / Restart =====
      scrollTopBtn.addEventListener("focus", () => {
        playVerbalFeedback(
          "Tombol kembali ke awal. Tekan Enter untuk mengulang permainan."
        );
      });
      scrollTopBtn.addEventListener("click", () => {
        restartGame();
      });
      function restartGame() {
        window.speechSynthesis.cancel();
        playVerbalFeedback(
          "Game diulang. Tekan Pilih Jajan untuk memulai lagi."
        );
        startGame();
      }

      function startGame() {
        basePrice = 0;
        itemQuantity = 0;
        itemPrice = 0;
        totalPaid = 0;
        itemNameDisplay.textContent = 'Tekan "Pilih Jajan"';
        itemGambarDisplay.innerHTML = "";
        itemPriceDisplay.textContent = "";
        quantityDisplay.textContent = "0";

        menuAktif = false; // reset menu aktif
        setMoneyButtonsTabIndex();
      }

      // ===== Tombol Back =====
      document.getElementById("btnBack").addEventListener("click", () => {
        const mode = localStorage.getItem("gameMode") || "audio";
        window.location.href = `menu.html?mode=${mode}`;
      });
      // stop audio on refresh
      window.addEventListener("beforeunload", () => {
        if ("speechSynthesis" in window) window.speechSynthesis.cancel();
      });

      window.addEventListener("load", () => {
        window.scrollTo({ top: 0, behavior: "instant" });
      });

      // Tekan keyboard (Enter / Space)
      document.addEventListener("keydown", (e) => {
        const tag = document.activeElement.tagName;
        if (e.key === "Backspace" && !["INPUT", "TEXTAREA"].includes(tag)) {
          e.preventDefault(); // cegah default scroll ke atas

          if (mode === "audio") {
            playVerbalFeedback("Kembali ke halaman utama");
          }

          // ganti ke halaman menu
          window.location.href = `menu.html?mode=${mode}`;
        }
      });
    </script>
  </body>
</html>
