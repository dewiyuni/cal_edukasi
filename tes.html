<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kasir Kelma - Belajar Uang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      :root {
        --primary-bg: #fef3c7;
        --accent-green: #38a169;
        --accent-yellow: #f6ad55;
      }
      body {
        font-family: "Poppins", sans-serif;
        background: #fff7ed;
        margin: 5px;
        display: flex;
        justify-content: center;
        align-items: flex-start;

        padding: 20px;
      }
      .kasir-container {
        background: #fff;
        border-radius: 20px;
        max-width: 900px;
        width: 100%;
        overflow: hidden;
        display: grid;
        grid-template-rows: auto 1fr;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }
      .header-scene {
        background-color: #fabb58;
        color: white;
        padding: 20px;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        text-align: center;
        position: relative;
        overflow: hidden;
        height: 160px;
      }
      @keyframes moveBackground {
        0% {
          background-position: 0 0;
        }
        100% {
          background-position: -600px 0;
        }
      }
      .header-scene::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-repeat: repeat-x;
        background-size: auto 100%;
        background-position: 0 0;
        animation: moveBackground 25s linear infinite;
        opacity: 0.5;
        z-index: 0;
      }
      .scene-content {
        position: relative;
        z-index: 2;
        text-align: center;
      }
      .cashier-img {
        background-image: url("https://placehold.co/80x80/ffffff/000000?text=K A S I R%0AK E L M A&font-size=20");
        background-size: cover;
        border-radius: 50%;
        border: 4px solid #fff;
        width: 110px;
        height: 110px;
        margin: 0 auto 10px;
      }
      .moving-items {
        position: absolute;
        top: 40%;
        left: 0;
        width: 200vw;
        display: flex;
        z-index: 1;
        animation: moveItems 20s linear infinite;
      }
      .moving-item {
        width: 100vw;
        height: auto;
        object-fit: cover;
        transform: translateY(-50%);
      }
      @keyframes moveItems {
        0% {
          transform: translateX(0);
        }
        100% {
          transform: translateX(-100vw);
        }
      }
      #moneyButtons {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
      }
      @media (max-width: 768px) {
        #moneyButtons {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .title {
        font-size: 28px;
        font-weight: 800;
        color: #ff7b00;
        margin-bottom: 10px;
        text-align: center; /* <-- ini menengahkan teks */
      }

      /* Tombol Pilih Jajan */
      .action-btn {
        background: #fbbf24; /* kuning cerah */
        color: #ffffff; /* teks gelap agar kontras */
        font-weight: 700;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px; /* spasi antara teks & loading */
        padding: 15px;
        border-radius: 15px;
        border: none;
        cursor: pointer;
        transition: transform 0.15s ease, background 0.2s ease;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

      .action-btn:hover {
        background: #fcd34d; /* lebih terang saat hover */
        transform: translateY(-2px);
      }

      .action-btn:active {
        transform: translateY(1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .start-container {
        display: inline-block;
      }

      .loading-spinner {
        /* border: 3px solid rgba(255, 255, 255, 0.3); */ /* hapus ini */
        border-top: 3px solid #1a202c; /* warna garis spinner */
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }

      .loading-spinner.hidden {
        display: none;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .money-btn img {
        width: 100%;
        height: 100px;
        object-fit: contain;
        border-radius: 8px;
      }
      #messageBox {
        padding: 10px;
        margin-top: 10px;
        border-radius: 10px;
        font-weight: bold;
        text-align: center;
      }
      .back-btn {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.85);
        color: #ea580c;
        font-weight: bold;
        padding: 8px 14px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        border: none;
        cursor: pointer;
        z-index: 9999;
        transition: 0.2s;
      }
      .back-btn:hover {
        background: white;
        transform: scale(1.05);
      }
      #scrollTopBtn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 45px;
        height: 45px;
        background: #ea580c;
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 22px;
        font-weight: bold;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
        z-index: 9999;
        transition: 0.3s ease;
      }
      #scrollTopBtn:hover {
        background: #c2410c;
      }
    </style>
  </head>
  <body>
    <div class="kasir-container">
      <button id="btnBack" class="back-btn">
        <i class="fas fa-arrow-left"></i>
      </button>
      <header class="header-scene" id="headerScene">
        <div class="scene-content"><div class="cashier-img"></div></div>
        <div class="moving-items">
          <img src="img/header.jpg" alt="header" class="moving-item" />
          <img src="img/header.jpg" alt="header" class="moving-item" />
        </div>
      </header>
      <main class="p-6">
        <h1 class="title">Kasir Kelma üç±‚ú®</h1>
        <div class="flex gap-3 w-full mb-4">
          <button
            id="btnPlus"
            class="action-btn btn-plus flex-[4] p-4 mb-3 rounded-xl flex items-center justify-center"
          >
            <span id="plusText">Pilih Jajan ‚ú®</span>
            <div
              id="plusLoading"
              class="loading-spinner hidden ml-2"
            ></div></button
          ><!-- Tombol Keranjang -->
          <button
            id="btnAddToCart"
            class="flex-[1] bg-green-600 text-white rounded-2xl flex items-center justify-center font-bold text-2xl shadow-md hover:bg-green-700 hover:scale-[1.05] active:scale-[0.95] transition h-[64px]"
            aria-label="Tambahkan ke keranjang"
            title="Tambah ke keranjang"
          >
            üõí
          </button>
        </div>
        <!-- Tambahkan class hidden ke semua elemen yang muncul step berikutnya -->
        <div
          id="itemGambarDisplay"
          class="w-full h-40 mb-3 bg-gray-100 flex items-center justify-center rounded-lg overflow-hidden hidden"
        ></div>
        <div
          id="itemNameDisplay"
          class="text-2xl font-bold text-center mb-4 hidden"
        ></div>
        <div
          id="itemPriceDisplay"
          class="flex items-center justify-center gap-3 mb-4 hidden"
        ></div>
        <div
          class="flex items-center justify-center gap-3 mb-4 hidden"
          id="quantityControls"
        >
          <button
            id="btnQuantityMinus"
            class="bg-red-500 w-10 h-10 text-white rounded-full disabled:opacity-50"
            disabled
          >
            -
          </button>
          <span
            id="quantityDisplay"
            class="text-3xl font-extrabold w-10 text-center"
            >0</span
          >
          <button
            id="btnQuantityPlus"
            class="bg-green-500 w-10 h-10 text-white rounded-full disabled:opacity-50"
            disabled
          >
            +
          </button>
        </div>
        <div
          id="keranjangSection"
          tabindex="-1"
          class="mt-10 p-4 bg-white rounded-lg shadow hidden"
        >
          <h2 class="text-xl font-bold mb-3">Keranjang Belanja</h2>
          <div id="listKeranjang" class="space-y-3"></div>
        </div>
        <button
          id="btnProceedPayment"
          disabled
          class="bg-blue-500 text-white p-3 mt-3 rounded-lg w-full mb-4 hidden"
        >
          Lanjut ke Bayar
        </button>
        <div id="moneyButtons" class="hidden"></div>

        <div id="messageBox" class="hidden"></div>
      </main>
    </div>
    <button id="scrollTopBtn">‚Üë</button>

    <script>
      const itemNameDisplay = document.getElementById("itemNameDisplay");
      const itemGambarDisplay = document.getElementById("itemGambarDisplay");
      const itemPriceDisplay = document.getElementById("itemPriceDisplay");
      const quantityDisplay = document.getElementById("quantityDisplay");
      const btnQuantityPlus = document.getElementById("btnQuantityPlus");
      const btnQuantityMinus = document.getElementById("btnQuantityMinus");
      const btnPlus = document.getElementById("btnPlus");
      const plusText = document.getElementById("plusText");
      const plusLoading = document.getElementById("plusLoading");
      const moneyButtonsContainer = document.getElementById("moneyButtons");
      const messageBox = document.getElementById("messageBox");
      const scrollTopBtn = document.getElementById("scrollTopBtn");
      const mode = localStorage.getItem("gameMode") || "audio";

      let basePrice = 0,
        itemQuantity = 0,
        itemPrice = 0,
        totalPaid = 0;
      const priceList = {
        "Ayam Goreng": 12000,
        Bakso: 10800,
        Batagor: 8500,
        "Bubur Ayam": 10000,
        Cilok: 5200,
        Cimol: 5400,
        Dimsum: 10900,
        Donat: 5500,
        "Es Buah": 8700,
        "Es Jeruk": 5600,
        "Es Krim": 6000,
        "Es Teh": 4000,
        "Es Teler": 10400,
        Jus: 7600,
        Kwetiau: 15700,
        Maklor: 5800,
        "Martabak Manis": 12700,
        "Martabak Telur": 15900,
        "Mie Ayam": 15000,
        Mineral: 3200,
        Nasgor: 15800,
        "Pecel Lele": 15000,
        "Risol Mayo": 6500,
        "Roti Bakar": 10500,
        Seblak: 8800,
        Somay: 8600,
        Soto: 12300,
        Takoyaki: 10700,
        "Telur Gulung": 3300,
        "Telur Puyuh": 4200,
      };
      const itemImages = {
        "Ayam Goreng": "img/menu/ayam_goreng.jpg",
        Bakso: "img/menu/bakso.jpeg",
        Batagor: "img/menu/batagor.jpg",
        "Bubur Ayam": "img/menu/bubur_ayam.jpeg",
        Cilok: "img/menu/cilok.jpeg",
        Cimol: "img/menu/cimol.jpeg",
        Dimsum: "img/menu/dimsum.jpeg",
        Donat: "img/menu/donat.jpeg",
        "Es Buah": "img/menu/es_buah.jpg",
        "Es Jeruk": "img/menu/es_jeruk.jpeg",
        "Es Krim": "img/menu/es_krim.jpeg",
        "Es Teh": "img/menu/es_teh.jpeg",
        "Es Teler": "img/menu/es_teler.jpeg",
        Jus: "img/menu/jus.jpeg",
        Kwetiau: "img/menu/kwetiau.jpeg",
        Maklor: "img/menu/maklor.jpeg",
        "Martabak Manis": "img/menu/martabak_manis.jpeg",
        "Martabak Telur": "img/menu/martabak_telur.jpeg",
        "Mie Ayam": "img/menu/mie_ayam.jpeg",
        Mineral: "img/menu/mineral.jpg",
        Nasgor: "img/menu/nasgor.jpeg",
        "Pecel Lele": "img/menu/pecel_lele.jpeg",
        "Risol Mayo": "img/menu/risol_mayo.jpeg",
        "Roti Bakar": "img/menu/roti_bakar.jpeg",
        Seblak: "img/menu/seblak.jpeg",
        Somay: "img/menu/somay.jpeg",
        Soto: "img/menu/soto.jpeg",
        Takoyaki: "img/menu/takoyaki.jpeg",
        "Telur Gulung": "img/menu/telur_gulung.jpeg",
        "Telur Puyuh": "img/menu/telur_puyuh.jpg",
      };
      const denominations = [
        100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000,
      ];
      const heroData = {
        100: { name: "Koin 100", img: "img/100.png" },
        200: { name: "Koin 200", img: "img/200.png" },
        500: { name: "Koin 500", img: "img/500.png" },
        1000: { name: "1 Ribu", img: "img/1000.png" },
        2000: { name: "2 Ribu", img: "img/2000.png" },
        5000: { name: "5 Ribu", img: "img/5000.png" },
        10000: { name: "10 Ribu", img: "img/10000.png" },
        20000: { name: "20 Ribu", img: "img/20000.png" },
        50000: { name: "50 Ribu", img: "img/50000.png" },
        100000: { name: "100 Ribu", img: "img/100000.png" },
      };

      function formatRupiah(n) {
        return new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
          minimumFractionDigits: 0,
        }).format(n);
      }
      function playVerbalFeedback(msg) {
        if (!msg) return;
        window.speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(msg);
        utter.lang = "id-ID";
        window.speechSynthesis.speak(utter);
      }
      function updateDisplay() {
        itemPriceDisplay.textContent = formatRupiah(itemPrice);
        quantityDisplay.textContent = itemQuantity;
        messageBox.classList.add("hidden");
      }
      function recalc() {
        itemPrice = basePrice * itemQuantity;
        updateDisplay();
      }

      // Listener click tunggal
      let menuAktif = false;

      // =======================
      // Main play menu audio
      // =======================
      async function playMenuAudio(name, price) {
        try {
          await playAudioAsync("audio/kasir_audio/menu_baru.mp3");
          await speakTextAsync(`${name}. Harganya ${formatRupiah(price)}.`);
          await playAudioAsync("audio/kasir_audio/instruksi1.mp3");
          await playAudioAsync("audio/kasir_audio/instruksi2.mp3");
        } catch (err) {
          console.error("Error playMenuAudio:", err);
        }
      }

      // =======================
      // Audio helper async
      // =======================
      let currentAudio = null;

      async function playAudioAsync(src) {
        return new Promise((resolve) => {
          if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
            currentAudio = null;
          }

          const audio = new Audio(src);
          currentAudio = audio;
          audio.onended = () => {
            currentAudio = null;
            resolve();
          };
          audio.onerror = () => {
            console.error("Audio gagal diputar:", src);
            resolve(); // jangan block jika error
          };
          audio.play();
        });
      }

      function speakTextAsync(text) {
        return new Promise((resolve) => {
          if (!text) return resolve();
          const utter = new SpeechSynthesisUtterance(text);
          utter.lang = "id-ID";
          utter.onend = resolve;
          utter.onerror = () => resolve(); // fallback
          window.speechSynthesis.speak(utter);
        });
      }

      // =======================
      // Load menu loop
      // =======================
      async function loadMenuLoop() {
        menuAktif = false;

        // hentikan audio lama
        window.speechSynthesis.cancel();
        if (currentAudio) {
          currentAudio.pause();
          currentAudio.currentTime = 0;
          currentAudio = null;
        }

        btnPlus.disabled = false; // tombol aktif segera
        menuAktif = true;

        try {
          const keys = Object.keys(priceList);
          const randomName = keys[Math.floor(Math.random() * keys.length)];

          basePrice = priceList[randomName];
          itemQuantity = 1;
          totalPaid = 0;

          recalc();

          // Update tampilan menu
          itemNameDisplay.textContent = randomName;
          itemGambarDisplay.innerHTML = `<img src="${itemImages[randomName]}" class="w-full h-full object-contain"/>`;

          itemGambarDisplay.classList.remove("hidden");
          itemNameDisplay.classList.remove("hidden");
          itemPriceDisplay.classList.remove("hidden");
          document
            .getElementById("quantityControls")
            .classList.remove("hidden");

          btnProceedPayment.classList.remove("hidden");
          btnProceedPayment.disabled = false;

          // Jalankan audio/TTS tanpa men-block tombol
          playMenuAudio(randomName, basePrice).catch((e) => console.error(e));
        } catch (err) {
          console.error("Error loadMenuLoop:", err);
        }
      }

      let loadingMenu = false;
      // ===== Tombol Pilih Jajan =====
      btnPlus.addEventListener("click", async () => {
        if (loadingMenu) return;

        loadingMenu = true;
        await loadMenuLoop();
        scrollToAfterHeader();
        loadingMenu = false;
      });

      btnPlus.addEventListener("keydown", async (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          if (loadingMenu) return;

          loadingMenu = true;
          await loadMenuLoop();
          loadingMenu = false;
        }
      });

      const audioJumlah = new Audio("audio/kasir_audio/jumlah.mp3");
      const audioTab = new Audio("audio/kasir_audio/lanjut_bayar.mp3");

      document.addEventListener("keydown", (e) => {
        if (!menuAktif) return;

        // Hanya izinkan tombol: +, = dan -
        if (e.key !== "+" && e.key !== "=" && e.key !== "-") return;

        // Stop semua suara dulu agar tidak bertabrakan
        speechSynthesis.cancel();
        audioJumlah.pause();
        audioJumlah.currentTime = 0;
        audioTab.pause();
        audioTab.currentTime = 0;

        // Fungsi TTS angka
        const playNumberTTS = (num, callback) => {
          const utterance = new SpeechSynthesisUtterance(`${num}`);
          utterance.lang = "id-ID";
          utterance.onend = callback;
          speechSynthesis.speak(utterance);
        };

        // Efek audio jumlah ‚Üí TTS angka ‚Üí audio lanjut pembayaran
        const handleQuantityChange = () => {
          audioJumlah.play();

          setTimeout(() => {
            playNumberTTS(itemQuantity, () => {
              audioTab.play();
            });
          }, 500); // tidak perlu 1 detik penuh
        };

        // Tambah jumlah
        if (e.key === "+" || e.key === "=") {
          if (itemQuantity < 99) itemQuantity++;
          recalc();
          handleQuantityChange();
        }

        // Kurangi jumlah
        if (e.key === "-") {
          if (itemQuantity > 1) itemQuantity--;
          recalc();
          handleQuantityChange();
        }
      });

      // scroll setelah header
      function scrollToAfterHeader() {
        const header = document.querySelector(".header-scene");
        if (!header) return;

        const y = header.offsetHeight;
        window.scrollTo({
          top: y,
          behavior: "smooth",
        });
      }

      const btnProceedPayment = document.getElementById("btnProceedPayment");

      async function playMoneyAudioSequence(introSrc, ttsText, enterSrc) {
        stopCurrentMoneyAudio();

        if (introSrc) {
          currentMoneyAudio = new Audio(introSrc);
          await new Promise((resolve) => {
            currentMoneyAudio.onended = resolve;
            currentMoneyAudio.play().catch(resolve); // fallback jika error
          });
          currentMoneyAudio = null;
        }

        if (ttsText) {
          await speakTextAsync(ttsText);
        }

        if (enterSrc) {
          currentMoneyAudio = new Audio(enterSrc);
          await new Promise((resolve) => {
            currentMoneyAudio.onended = resolve;
            currentMoneyAudio.play().catch(resolve);
          });
          currentMoneyAudio = null;
        }
      }
      let currentMoneyAudio = null;

      function stopCurrentMoneyAudio() {
        // hentikan audio sebelumnya
        if (currentMoneyAudio) {
          currentMoneyAudio.pause();
          currentMoneyAudio.currentTime = 0;
          currentMoneyAudio = null;
        }
        // hentikan TTS jika sedang berjalan
        window.speechSynthesis.cancel();
      }

      // variabel global untuk audio sementara tombol uang
      btnProceedPayment.addEventListener("click", () => {
        moneyButtonsContainer.classList.remove("hidden");
        moneyButtonsContainer.innerHTML = ""; // Kosongkan dulu

        // üîπ Tambahkan ini
        let totalPrice = getTotalKeranjang(); // total semua item
        totalPaid = 0;
        denominations.forEach((value) => {
          const btn = document.createElement("button");
          const data = heroData[value];
          btn.innerHTML = `<img src="${data.img}" alt="${data.name}"/>
                     <span style="font-size:0.7rem;display:block;text-align:center;">${data.name}</span>`;
          btn.classList.add("money-btn");

          btn.addEventListener("click", async () => {
            stopCurrentMoneyAudio();
            totalPaid += value;
            const remaining = totalPrice - totalPaid;
            const change = Math.abs(remaining);

            if (remaining > 0) {
              await playMoneyAudioSequence(
                "audio/kasir_audio/kamu_memasukkan.mp3",
                formatRupiah(value),
                "audio/kasir_audio/sisa_membayar.mp3"
              );
              await speakTextAsync(formatRupiah(remaining));
            } else {
              await playMoneyAudioSequence(
                "audio/kasir_audio/kamu_bayar.mp3",
                formatRupiah(totalPaid)
              );
              if (change > 0) {
                await playMoneyAudioSequence(
                  "audio/kasir_audio/kembalian.mp3",
                  formatRupiah(change)
                );
              }
              await playMoneyAudioSequence(
                "audio/kasir_audio/transaksi_selesai.mp3"
              );
              startGame();
            }
          });

          btn.addEventListener("focus", () => {
            playMoneyAudioSequence(
              "audio/kasir_audio/ini.mp3",
              data.name,
              "audio/kasir_audio/enter.mp3"
            ).catch(console.error);
          });

          moneyButtonsContainer.appendChild(btn);
        });

        // Fokus tombol pertama
        const firstMoneyBtn = moneyButtonsContainer.querySelector("button");
        if (firstMoneyBtn) firstMoneyBtn.focus();
      });

      // Index tombol uang yang sedang fokus
      let currentMoneyIndex = 0;

      function focusMoneyBtn(index) {
        const buttons = moneyButtonsContainer.querySelectorAll("button");
        if (buttons.length === 0) return;
        if (index < 0) index = 0;
        if (index >= buttons.length) index = buttons.length - 1;
        currentMoneyIndex = index;
        buttons[currentMoneyIndex].focus();
      }

      // Listener global untuk ArrowLeft, ArrowRight, Enter
      document.addEventListener("keydown", (e) => {
        const buttons = moneyButtonsContainer.querySelectorAll("button");
        if (buttons.length === 0) return;

        if (document.activeElement.closest("#moneyButtons")) {
          if (e.key === "ArrowRight") {
            e.preventDefault();
            focusMoneyBtn(currentMoneyIndex + 1);
          }
          if (e.key === "ArrowLeft") {
            e.preventDefault();
            focusMoneyBtn(currentMoneyIndex - 1);
          }
          if (e.key === "Enter") {
            e.preventDefault();
            buttons[currentMoneyIndex].click();
          }
        }
      });

      // Keyboard: tekan Tab dari quantityDisplay ‚Üí fokus ke Lanjut ke Bayar
      quantityDisplay.addEventListener("keydown", (e) => {
        if (e.key === "Tab" && !btnProceedPayment.disabled) {
          e.preventDefault(); // cegah default tab
          btnProceedPayment.focus(); // fokus ke tombol Lanjut

          // mainkan audio
          const audioLanjut = new Audio("audio/kasir_audio/bayar.mp3");
          audioLanjut.play();
        }
      });
      document.addEventListener("keydown", (e) => {
        const active = document.activeElement;

        // Dari tampilan keranjang ‚Üí Tab atau ArrowRight pindah ke Lanjut Bayar
        if (
          active === keranjangSection &&
          (e.key === "Tab" || e.key === "ArrowRight")
        ) {
          e.preventDefault();
          btnProceedPayment.focus();
        }

        // Dari Lanjut Bayar ‚Üí ArrowLeft kembali ke Pilih Jajan
        if (active === btnProceedPayment && e.key === "ArrowLeft") {
          e.preventDefault();
          btnPlus.focus();
        }

        // Dari tampilan keranjang ‚Üí ArrowLeft pindah ke Pilih Jajan
        if (active === keranjangSection && e.key === "ArrowLeft") {
          e.preventDefault();
          btnPlus.focus();
        }
      });

      // Kalau tombol mendapat fokus langsung
      btnProceedPayment.addEventListener("focus", () => {
        const audioLanjut = new Audio("audio/kasir_audio/bayar.mp3");
        audioLanjut.play();
      });

      // scroll ke pembayaran
      function scrollToAftertbnbayar() {
        const header = document.querySelector(".header-scene");
        if (!header) return;

        const y = header.offsetHeight;
        window.scrollTo({
          top: y,
          behavior: "smooth",
        });
      }
      // ===== Fokus Tab Awal =====
      function setMoneyButtonsTabIndex() {
        btnPlus.setAttribute("tabindex", "0");
        btnPlus.focus();
        quantityDisplay.setAttribute("tabindex", "1");
        moneyButtonsContainer
          .querySelectorAll("button")
          .forEach((b) => b.setAttribute("tabindex", "2"));
        scrollTopBtn.setAttribute("tabindex", "99");
      }

      // ===== Fokus Tab Setelah Menu Dipilih =====
      function setMoneyButtonsTabIndexAfterMenu() {
        btnPlus.setAttribute("tabindex", "0"); // Pilih Jajan
        // Hapus tabindex quantityDisplay
        quantityDisplay.removeAttribute("tabindex");
        // Hapus tombol plus/minus dari tab
        btnQuantityMinus.setAttribute("tabindex", "-1");
        btnQuantityPlus.setAttribute("tabindex", "-1");

        // Tombol uang fokusable setelah Pilih Jajan
        moneyButtonsContainer
          .querySelectorAll("button")
          .forEach((b, i) => b.setAttribute("tabindex", 1 + i));

        scrollTopBtn.setAttribute("tabindex", 99); // tombol scroll/restart
      }

      // ===== Inisialisasi Awal =====
      async function playIntroAudio() {
        // hentikan semua TTS dan audio sebelumnya
        window.speechSynthesis.cancel();

        // mainkan audio intro dan tunggu selesai
        await playAudioAsync("audio/kasir_audio/awal.mp3");
      }

      // saat load
      window.addEventListener("load", async () => {
        await playIntroAudio(); // tunggu audio intro selesai
        setMoneyButtonsTabIndex();
        btnPlus.disabled = false; // hidupkan tombol setelah selesai
      });

      // ===== Tombol Scroll Top / Restart =====
      scrollTopBtn.addEventListener("focus", () => {
        playVerbalFeedback(
          "Tombol kembali ke awal. Tekan Enter untuk mengulang permainan."
        );
      });
      scrollTopBtn.addEventListener("click", () => {
        restartGame();
      });
      function restartGame() {
        window.speechSynthesis.cancel();
        playVerbalFeedback(
          "Game diulang. Tekan Pilih Jajan untuk memulai lagi."
        );
        startGame();
      }

      function startGame() {
        basePrice = 0;
        itemQuantity = 0;
        itemPrice = 0;
        totalPaid = 0;
        menuAktif = false;

        // Reset tampilan
        itemNameDisplay.textContent = 'Tekan "Pilih Jajan"';
        itemGambarDisplay.innerHTML = "";
        itemPriceDisplay.textContent = "";
        quantityDisplay.textContent = "0";

        // Sembunyikan elemen aktif
        moneyButtonsContainer.classList.add("hidden");
        document.getElementById("quantityControls").classList.add("hidden");
        btnProceedPayment.classList.add("hidden");

        // Reset keranjang lokal
        localStorage.removeItem("cartItems");
        renderKeranjang();

        // Set fokus awal
        setMoneyButtonsTabIndex();
      }

      // ===== Tombol Back =====
      document.getElementById("btnBack").addEventListener("click", () => {
        const mode = localStorage.getItem("gameMode") || "audio";
        window.location.href = `menu.html?mode=${mode}`;
      });
      // stop audio on refresh
      window.addEventListener("beforeunload", () => {
        // hentikan TTS
        if ("speechSynthesis" in window) window.speechSynthesis.cancel();

        // hentikan audio global
        if (currentAudio) {
          currentAudio.pause();
          currentAudio.currentTime = 0;
          currentAudio = null;
        }

        // hentikan audio lainnya jika ada
        [audioJumlah, audioTab, audioKeranjang].forEach((a) => {
          if (a && !a.paused) {
            a.pause();
            a.currentTime = 0;
          }
        });
      });

      window.addEventListener("load", () => {
        startGame(); // reset semua saat halaman dibuka/reload
        window.scrollTo({ top: 0, behavior: "instant" });
      });

      window.addEventListener("beforeunload", () => {
        localStorage.removeItem("cartItems"); // hapus keranjang saat refresh/close
        if ("speechSynthesis" in window) window.speechSynthesis.cancel();
      });

      // Tekan keyboard (Enter / Space)
      document.addEventListener("keydown", (e) => {
        const tag = document.activeElement.tagName;
        if (e.key === "Backspace" && !["INPUT", "TEXTAREA"].includes(tag)) {
          e.preventDefault(); // cegah default scroll ke atas
          // ganti ke halaman menu
          window.location.href = `menu.html?mode=${mode}`;
        }
      });
      // ================= KERANJANG =================

      // Tombol Tambah ke Keranjang
      const btnAddToCart = document.getElementById("btnAddToCart");

      // Fokus ‚Üí mainkan audio keranjang
      btnAddToCart.addEventListener("focus", () => {
        audioKeranjang.currentTime = 0;
        audioKeranjang.play().catch((err) => console.error(err));
      });

      // Enter ‚Üí tambahkan ke keranjang + mainkan audio lanjut bayar
      btnAddToCart.addEventListener("keydown", (e) => {
        if (e.key !== "Enter") return;

        e.preventDefault();
        e.stopPropagation();

        // Tambah ke keranjang
        const itemName = itemNameDisplay.textContent;
        const itemImg = itemGambarDisplay.querySelector("img")?.src || "";
        const qty = itemQuantity;
        const price = basePrice;

        let cart = JSON.parse(localStorage.getItem("cartItems") || "[]");
        const existing = cart.find((item) => item.name === itemName);

        if (existing) {
          existing.qty += qty;
        } else {
          cart.push({ name: itemName, img: itemImg, price, qty });
        }

        localStorage.setItem("cartItems", JSON.stringify(cart));
        renderKeranjang();

        // Audio aman
        playAudioAsync("audio/kasir_audio/lanjut_bayar.mp3");

        // Pastikan keranjang bisa fokus
        keranjangSection.setAttribute("tabindex", "0");

        // Scroll ke keranjang dan fokus ke container
        keranjangSection.scrollIntoView({ behavior: "smooth" });
        keranjangSection.focus(); // sekarang keranjang bisa menerima keyboard
      });
      // total keranjang
      function getTotalKeranjang() {
        const cart = JSON.parse(localStorage.getItem("cartItems") || "[]");
        return cart.reduce((sum, item) => sum + item.price * item.qty, 0);
      }

      // Fungsi render keranjang
      function renderKeranjang() {
        const listKeranjang = document.getElementById("listKeranjang");
        const keranjangSection = document.getElementById("keranjangSection");

        let cart = JSON.parse(localStorage.getItem("cartItems") || "[]");

        if (cart.length === 0) {
          keranjangSection.classList.add("hidden");
          listKeranjang.innerHTML = "";
          return;
        }

        keranjangSection.classList.remove("hidden");
        listKeranjang.innerHTML = "";

        cart.forEach((item) => {
          const row = document.createElement("div");
          row.className =
            "flex items-center justify-between p-3 bg-gray-100 rounded-lg";

          row.innerHTML = `
            <div class="flex items-center gap-3">
              <img src="${item.img}" class="w-12 h-12 rounded object-cover">
              <div>
                <p class="font-semibold">${item.name}</p>
                <p class="text-sm text-gray-600">Qty: ${item.qty}</p>
              </div>
            </div>
            <p class="font-bold">${item.price * item.qty}</p>
          `;

          listKeranjang.appendChild(row);
        });
      }

      // ================= Audio Fokus / Enter =================
      const keranjangSection = document.getElementById("keranjangSection");
      const audioKeranjang = new Audio("audio/kasir_audio/keranjang.mp3"); // audio fokus Tab

      // Render keranjang awal saat load
      renderKeranjang();

      // reset
      function resetMenuForNextChoice() {
        menuAktif = false;
        loadingMenu = false;
        btnPlus.disabled = false; // pastikan tombol hidup
        itemNameDisplay.textContent = 'Tekan "Pilih Jajan"';
        itemGambarDisplay.innerHTML = "";
        itemPriceDisplay.textContent = "";
        quantityDisplay.textContent = "0";

        // sembunyikan elemen lain
        document.getElementById("quantityControls").classList.add("hidden");
        btnProceedPayment.classList.add("hidden");
        moneyButtonsContainer.classList.add("hidden");
      }
    </script>
  </body>
</html>
