<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jodohkan Gambar - HP & Laptop Aksesibel</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary-bg: #fef3c7;
        --header-bg: #ea580c;
        --accent-green: #38a169;
        --accent-yellow: #f6ad55;
        --display-blue: #3182ce;
        --font-inter: "Inter", sans-serif;
      }
      body {
        font-family: "Poppins", sans-serif;
        background: #fff7ed;
        margin: 5px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
      }
      .container {
        width: 100%;
        max-width: 1100px;
        margin: 0 auto;
        text-align: center;
        padding: 10px 20px;
        box-sizing: border-box;
      }
      .header-scene {
        position: relative;
        overflow: hidden;
        height: 120px;
        max-width: 900px;
        margin: 0 auto;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        text-align: center;
        color: white;
        padding: 20px;
      }
      .moving-bg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("img/bg header.png");
        background-repeat: repeat-x;
        background-size: 100%;
        background-position: 0 0;
        animation: moveBackground 25s linear infinite;
        z-index: 0;
      }
      @keyframes moveBackground {
        0% {
          background-position: 0 0;
        }
        100% {
          background-position: -1000px 0;
        }
      }
      main {
        background: white;
        padding: 20px;
        border-radius: 0 0 20px 20px;
        box-shadow: 1px 1px #fabb58;
        width: 100%;
        max-width: 940px;
        margin: 0 auto;
        box-sizing: border-box;
        position: relative;
      }
      .cashier-img {
        position: relative;
        z-index: 1;
        width: 120px;
        height: 120px;
        margin: 0 auto;
        background-color: #ff7b00;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        border: 4px solid #ff7b00;
      }
      .cashier-text {
        color: white;
        font-size: 18px;
        font-weight: bold;
        text-align: center;
        line-height: 1.2;
      }
      .title {
        font-size: 28px;
        font-weight: 800;
        color: #ff7b00;
        margin-bottom: 10px;
      }
      .info-box {
        display: flex;
        justify-content: space-between;
        padding: 12px 15px;
        background: white;
        border: 3px solid #ffae42;
        border-radius: 15px;
        margin: 0 auto 20px;
        width: 85%;
        font-size: 18px;
        box-shadow: 4px 4px 0 #ffa726;
      }
      #floatingInfo {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.8);
        padding: 8px 12px;
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
        gap: 15px;
        font-size: 14px;
        box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      #floatingInfo.visible {
        opacity: 1;
      }
      .start-container button {
        padding: 12px 18px;
        font-size: 18px;
        font-weight: bold;
        border-radius: 15px;
        border: 3px solid #ff9800;
        background: #fff3cd;
        box-shadow: 4px 4px 0 #ffa726;
        cursor: pointer;
        margin-bottom: 20px;
      }
      .start-container button:hover {
        background: #ffe28a;
        transform: scale(1.05);
        transition: 0.2s;
      }
      #gameArea {
        display: none;
        width: 100%;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 15px;
        margin-top: 20px;
        width: 100%;
      }
      .choice {
        background: white;
        border: 3px solid #ffa726;
        border-radius: 15px;
        padding: 10px;
        cursor: pointer;
        box-shadow: 4px 4px 0 #ffb74d;
        transition: 0.15s;
      }
      .choice:hover {
        transform: scale(1.07);
      }
      .choice img {
        width: 100%;
        height: 140px;
        object-fit: contain;
        margin: 20px auto 0 auto;
      }
      .choice:focus {
        outline: 4px solid blue;
      }
      #targetImage img {
        width: 40%;
        max-width: 300px;
        height: auto;
        object-fit: contain;
        display: block;
        margin: 12px auto;
        box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.3);
        border-radius: 10px;
      }
      .correct {
        border-color: #4ade80 !important;
        box-shadow: 4px 4px 0 #22c55e !important;
      }
      .wrong {
        animation: shake 0.3s;
        border-color: #ef4444 !important;
        box-shadow: 4px 4px 0 #dc2626 !important;
      }
      @keyframes shake {
        0% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        50% {
          transform: translateX(5px);
        }
        75% {
          transform: translateX(-5px);
        }
        100% {
          transform: translateX(0);
        }
      }
      #feedback {
        font-size: 24px;
        font-weight: bold;
        margin-top: 15px;
        min-height: 40px;
        line-height: 40px;
        padding: 5px 10px;
        border-radius: 10px;
        transition: all 0.3s ease;
        opacity: 0;
        transform: scale(0.8);
      }
      #feedback.correct {
        color: #22c55e;
        background: #d1fae5;
        border: 2px solid #22c55e;
        opacity: 1;
        transform: scale(1);
      }
      #feedback.wrong {
        color: #ef4444;
        background: #fee2e2;
        border: 2px solid #ef4444;
        opacity: 1;
        transform: scale(1);
        animation: shake 0.3s;
      }
      .back-btn {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.85);
        color: #ea580c;
        font-weight: bold;
        padding: 8px 14px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        border: none;
        cursor: pointer;
        z-index: 9999;
        transition: 0.2s;
      }
      .back-btn:hover {
        background: white;
        transform: scale(1.05);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <button id="btnBack" class="back-btn" tabindex="0">
        <i class="fas fa-arrow-left"></i>
      </button>
      <header class="header-scene">
        <div class="moving-bg"></div>
        <div class="moving-bg"></div>
        <div class="cashier-img">
          <span class="cashier-text">Uang<br />Match</span>
        </div>
      </header>
      <main>
        <h1 class="title">Menjodohkan Gambar üç±‚ú®</h1>
        <div class="info-box" id="judulGame">
          <p>Skor: <span id="score">0</span></p>
          <p>Nyawa: <span id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></p>
          <p>Level: <span id="level">1</span></p>
        </div>
        <div id="floatingInfo">
          <p>Skor: <span id="scoreFloat">0</span></p>
          <p>Nyawa: <span id="livesFloat">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></p>
          <p>Level: <span id="levelFloat">1</span></p>
        </div>
        <div class="start-container">
          <button id="startBtn" tabindex="0" aria-label="Mulai Permainan">
            Mulai Permainan
          </button>
        </div>
        <div id="gameArea">
          <h2 id="instruction">Cari gambar yang sama</h2>
          <div id="targetImage"></div>
          <div id="gridContainer" class="grid"></div>
        </div>
        <div id="feedback"></div>
      </main>
    </div>

    <script>
      // SINGLE SPEAK UTILITY
      function speak(text, onEnd = null, skipCancel = false) {
        if (!("speechSynthesis" in window)) return;
        if (!skipCancel) window.speechSynthesis.cancel(); // hanya cancel kalau bukan welcome
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = "id-ID";
        msg.rate = 0.95;
        msg.pitch = 1;
        if (onEnd) msg.onend = onEnd;
        window.speechSynthesis.speak(msg);
      }

      function stopSpeak() {
        if ("speechSynthesis" in window) {
          window.speechSynthesis.cancel();
        }
      }
      // === DATA (tetap di luar) ===
      const moneyImages = {
        1000: "img/1000.png",
        2000: "img/2000.png",
        5000: "img/5000.png",
        10000: "img/10000.png",
        20000: "img/20000.png",
        50000: "img/50000.png",
        100000: "img/100000.png",
      };
      const itemImages = {
        1000: [
          { src: "img/permen.jpg", label: "Permen" },
          { src: "img/ballon.png", label: "Balon" },
          { src: "img/pensil-mini.png", label: "Pensil Mini" },
        ],

        2000: [
          { src: "img/bengbeng.jpeg", label: "Beng-beng" },
          { src: "img/nabati.jpeg", label: "Nabati" },
          { src: "img/tango.jpeg", label: "Tango" },
          { src: "img/penghapus.jpeg", label: "Penghapus" },
        ],

        5000: [
          { src: "img/coklat.png", label: "Coklat" },
          { src: "img/chikitwist.jpeg", label: "Chiki Twist" },
          { src: "img/ultramilk.jpeg", label: "Ultra Milk" },
          { src: "img/ganci.jpeg", label: "Gantungan Kunci" },
          { src: "img/gelang.png", label: "Gelang" },
          { src: "img/jepit.jpg", label: "Jepit Rambut" },
        ],

        10000: [
          { src: "img/cake.jpg", label: "Kue" },
          { src: "img/frenchfries.jpeg", label: "Kentang Goreng" },
          { src: "img/nescafe.jpeg", label: "Nescafe" },
          { src: "img/kaoskaki.jpeg", label: "Kaos Kaki" },
        ],

        20000: [
          { src: "img/botol.jpeg", label: "Botol Minum" },
          { src: "img/topi.jpg", label: "Topi" },
          { src: "img/sendal.jpeg", label: "Sandal" },
        ],

        50000: [
          { src: "img/boneka.png", label: "Boneka" },
          { src: "img/jashujan.jpeg", label: "Jas Hujan" },
          { src: "img/tas.png", label: "Tas" },
        ],

        100000: [
          { src: "img/mobil.jpeg", label: "Mobil Mainan" },
          { src: "img/sepatu.jpeg", label: "Sepatu" },
        ],
      };

      // === STATE DEFAULTS ===
      let score = 0,
        level = 1,
        lives = 3,
        totalCorrect = 0,
        finishedGame = false,
        lastQuestion = null,
        gameRunning = false;

      // DOM setup after DOM ready
      document.addEventListener("DOMContentLoaded", () => {
        // grab elements
        const scoreDisplay = document.getElementById("score");
        const livesDisplay = document.getElementById("lives");
        const levelDisplay = document.getElementById("level");
        const scoreFloatDisplay = document.getElementById("scoreFloat");
        const livesFloatDisplay = document.getElementById("livesFloat");
        const levelFloatDisplay = document.getElementById("levelFloat");
        let startBtn = document.getElementById("startBtn");
        let targetImage = document.getElementById("targetImage");
        let gridContainer = document.getElementById("gridContainer");
        let gameArea = document.getElementById("gameArea");
        let feedbackDisplay = document.getElementById("feedback");
        const titleEl = document.querySelector(".title");
        let backBtn = document.getElementById("btnBack");
        // expose to outer scope if needed by other funcs (some functions below use these names)
        window.startBtn = startBtn;
        window.targetImage = targetImage;
        window.gridContainer = gridContainer;
        window.gameArea = gameArea;
        window.feedbackDisplay = feedbackDisplay;
        // Batasi TAB hanya antara dua tombol ini
        document.addEventListener("keydown", (e) => {
          if (e.key !== "Tab") return;

          const focusables = [backBtn, startBtn];
          const currentIndex = focusables.indexOf(document.activeElement);

          // Cegah fokus ke elemen aneh sebelum game mulai
          if (!gameRunning) {
            document
              .querySelectorAll(".title, .info-box, #floatingInfo")
              .forEach((el) => el.setAttribute("tabindex", "-1"));
          }

          if (e.shiftKey) {
            if (currentIndex === 0) {
              e.preventDefault();
              focusables[1].focus();
            }
          } else {
            if (currentIndex === 1) {
              e.preventDefault();
              focusables[0].focus();
            }
          }
        });

        // accessibility: allow focus on info items
        titleEl.setAttribute("tabindex", "0");
        scoreDisplay.parentElement.setAttribute("tabindex", "0");
        livesDisplay.parentElement.setAttribute("tabindex", "0");
        levelDisplay.parentElement.setAttribute("tabindex", "0");

        // welcome voice once
        window.addEventListener("load", () => {
          speak(
            "Selamat datang di game menjodohkan gambar.",
            () => {
              startBtn.focus();
              speak(
                "Fokus ke tombol mulai permainan. Tekan Enter untuk memulai."
              );
            },
            true // skipCancel
          );
        });

        // focus voice handlers
        titleEl.addEventListener("focus", () => {
          speak("Judul permainan: Menjodohkan Gambar");
        });
        startBtn.addEventListener("focus", () => {
          speak("Tombol mulai permainan. Tekan Enter untuk memulai permainan.");
        });
        // Suara saat fokus ke tombol BACK
        backBtn.addEventListener("focus", () => {
          speak("Tombol kembali. Tekan Enter untuk kembali ke menu.");
        });
        // start button actions
        startBtn.addEventListener("click", () => {
          startBtn.style.display = "none";
          gameArea.style.display = "block";
          // Aktifkan tab untuk elemen game setelah mulai
          document.querySelectorAll(".choice").forEach((el) => {
            el.setAttribute("tabindex", "0");
          });

          startGame();
          // ‚úÖ Tunggu sedikit biar layout muncul dulu
          setTimeout(() => {
            scrollToAfterHeader();
          }, 200);

          if (isVisualMode()) {
            setTimeout(() => {
              speak(
                "Permainan dimulai. Pilih gambar yang sesuai dengan harga yang diminta."
              );
            }, 500);
          }
        });
        startBtn.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            startBtn.click();
          }
        });

        // BACK TO MENU
        backBtn.addEventListener("click", () => {
          window.location.href = "menu.html?mode=audio";
        });

        // Keyboard (ENTER / SPACE)
        backBtn.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            window.location.href = "menu.html?mode=audio";
          }
        });

        // GAME FUNCTIONS (use closures to access local elements)
        function updateDisplay() {
          scoreDisplay.textContent = score;
          levelDisplay.textContent = level;
          scoreFloatDisplay.textContent = score;
          levelFloatDisplay.textContent = level === "Selesai" ? "‚úÖ" : level;
          livesDisplay.textContent = "‚ù§Ô∏è".repeat(lives);
          livesFloatDisplay.textContent = "‚ù§Ô∏è".repeat(lives);
        }

        function startGame() {
          score = 0;
          level = 1;
          lives = 3;
          gameRunning = true;
          totalCorrect = 0;
          finishedGame = false;
          lastQuestion = null;
          updateDisplay();
          loadRound(false);
        }

        function loadRound(repeat = false) {
          if (!gameRunning || finishedGame) return;
          stopSpeak();

          // ambil semua key uang
          const keys = Object.keys(moneyImages);

          if (!repeat) {
            const correctKey = keys[Math.floor(Math.random() * keys.length)];
            const otherKeys = keys.filter((k) => k !== correctKey);
            const choicesKeys = otherKeys
              .sort(() => Math.random() - 0.5)
              .slice(0, 2);
            choicesKeys.push(correctKey);
            choicesKeys.sort(() => Math.random() - 0.5);
            lastQuestion = { correctKey, choicesKeys };
          }

          const { correctKey, choicesKeys } = lastQuestion;
          window.currentAnswer = correctKey;

          // tampilkan gambar uang target
          targetImage.innerHTML = `<img src="${moneyImages[correctKey]}" alt="uang ${correctKey} rupiah">`;

          gridContainer.innerHTML = "";
          let allChoicesVoice = "";

          choicesKeys.forEach((key, index) => {
            // ambil array item untuk harga ini
            const items = itemImages[key];

            // jika tidak ada item untuk key ini, buat placeholder sederhana agar tidak error
            if (!items || !Array.isArray(items) || items.length === 0) {
              const divPlaceholder = document.createElement("div");
              divPlaceholder.className = "choice";
              divPlaceholder.setAttribute("tabindex", "0");
              divPlaceholder.innerHTML = `
        <div style="padding:20px;">Tidak ada barang</div>
        <p style="margin-top:8px;font-weight:bold;font-size:16px;color:#ff7b00;">
          Rp ${Number(key).toLocaleString()}
        </p>
      `;
              divPlaceholder.addEventListener("click", () =>
                speak("Tidak ada barang untuk pilihan ini")
              );
              divPlaceholder.addEventListener("focus", () =>
                speak(
                  `Pilihan ${index + 1}: tidak ada barang, harga ${key} rupiah`
                )
              );
              gridContainer.appendChild(divPlaceholder);
              allChoicesVoice += `Pilihan ${
                index + 1
              }: tidak ada barang, harga ${key} rupiah. `;
              return;
            }

            // ambil item random dari array
            const randomItem = items[Math.floor(Math.random() * items.length)];

            const div = document.createElement("div");
            div.className = "choice";
            div.setAttribute("tabindex", "0");

            // gunakan randomItem untuk label dan src
            div.setAttribute(
              "aria-label",
              `Pilihan ${index + 1}: ${randomItem.label}, harga ${key} rupiah`
            );

            div.innerHTML = `
      <img src="${randomItem.src}" alt="${randomItem.label}">
      <p style="margin-top:8px;font-weight:bold;font-size:16px;color:#ff7b00;">
        Rp ${Number(key).toLocaleString()}
      </p>
    `;

            div.addEventListener("click", () =>
              handleChoice(div, key, correctKey)
            );
            div.addEventListener("focus", () =>
              speak(
                `Pilihan ${index + 1}: ${randomItem.label}, harga ${key} rupiah`
              )
            );

            gridContainer.appendChild(div);
            allChoicesVoice += `Pilihan ${index + 1}: ${
              randomItem.label
            }, harga ${key} rupiah. `;
          });

          // sekarang bicara semua pilihan (panggil speak setelah semua dibuat)
          speak(
            `Cari barang dengan harga ${correctKey} rupiah. ${allChoicesVoice} Gunakan tombol angka 1 sampai ${choicesKeys.length} untuk memilih.`
          );
        }

        function handleChoice(div, selected, correct) {
          if (!gameRunning) return;
          stopSpeak();
          if (selected == correct) {
            div.classList.add("correct");
            feedbackDisplay.textContent = "‚úÖ Benar!";
            feedbackDisplay.className = "correct";
            speak("Benar");
            score++;
            totalCorrect++;
            checkLevelUp();
            setTimeout(() => {
              feedbackDisplay.textContent = "";
              feedbackDisplay.className = "";
              if (!finishedGame) loadRound(false);
            }, 1200);
          } else {
            div.classList.add("wrong");
            feedbackDisplay.textContent = "‚ùå Salah, coba lagi";
            feedbackDisplay.className = "wrong";
            speak("Salah");
            lives--;
            updateDisplay();
            if (lives <= 0) {
              finishedGame = true;
              gameRunning = false;
              feedbackDisplay.textContent = "üíÄ Permainan berakhir!";
              showFinishScreen(false);
              return;
            }
            setTimeout(() => {
              feedbackDisplay.textContent = "";
              feedbackDisplay.className = "";
              loadRound(true);
            }, 1200);
          }
          updateDisplay(); // Saat load halaman
        }
        window.addEventListener("load", () => {
          const wasGameOver = localStorage.getItem("gameOver");
          if (wasGameOver === "true") {
            feedbackDisplay.textContent = "üíÄ Permainan berakhir!";
          }
        });

        function checkLevelUp() {
          if (finishedGame) return;
          if (level === 1 && totalCorrect >= 3) {
            level = 2;
            speak(`Level 2`);
            showLevelNotif(`Level ${level}`);
          } else if (level === 2 && totalCorrect >= 5) {
            level = 3;
            speak(`Level3`);
            showLevelNotif(`Level ${level}`);
          } else if (level === 3 && totalCorrect >= 10) {
            finishedGame = true;
            gameRunning = false;
            // finish speech then show finish screen
            speak("Semua level selesai", () => {
              showFinishScreen(true);
            });
            showLevelNotif("Semua Level Selesai!");
            return;
          }
          updateDisplay();
        }

        let hasShownFinishNotif = false;
        function showLevelNotif(text) {
          if (hasShownFinishNotif) return;
          // case-insensitive check for selesai/selesai words
          if (
            typeof text === "string" &&
            text.toLowerCase().includes("selesai")
          ) {
            hasShownFinishNotif = true;
          }
          const notif = document.createElement("div");
          notif.textContent = text.includes("Level")
            ? `üéâ ${text}`
            : `üèÜ ${text}`;
          const isFinish =
            typeof text === "string" && text.toLowerCase().includes("selesai");
          Object.assign(notif.style, {
            background: isFinish ? "#d69e2e" : "#38a169",
            position: "fixed",
            top: "50%",
            left: "50%",
            transform: "translate(-50%,-50%)",
            color: "white",
            padding: "15px 25px",
            fontSize: "24px",
            borderRadius: "15px",
            boxShadow: "0 4px 10px rgba(0,0,0,0.3)",
            zIndex: 9999,
            opacity: 0,
            transition: "opacity 0.3s ease",
          });
          document.body.appendChild(notif);
          requestAnimationFrame(() => (notif.style.opacity = 1));
          setTimeout(() => {
            notif.style.opacity = 0;
            setTimeout(() => notif.remove(), 300);
          }, 2000);
        }

        // FINISH SCREEN
        function showFinishScreen(win = true) {
          gameRunning = false;
          // mark level display as finished (optional)
          level = "Selesai";
          updateDisplay();

          gameArea.innerHTML = `
                            <div id="finishScreen" style="text-align:center; padding:20px;">
                              <h2>${win ? "üéâ Selamat!" : "üíÄ Game Over"}</h2>
                              <p>${
                                win
                                  ? "Selamat! Kamu telah menyelesaikan semua level!"
                                  : "Nyawa habis, coba lagi ya!"
                              }</p>
                              <div style="margin-top:12px;">
                                <button id="restartBtnFinish" tabindex="0">Restart Game</button>
                                <button id="backToMenuBtn" tabindex="0" style="margin-left:10px;">Kembali ke Menu</button>
                              </div>
                            </div>
                          `;
          const restartBtnFinish = document.getElementById("restartBtnFinish");
          const backToMenuBtn = document.getElementById("backToMenuBtn");
          // stop suara lama
          stopSpeak();

          // fokus dulu
          setTimeout(() => {
            restartBtnFinish.focus();
          }, 200);

          // suara setelah fokus
          setTimeout(() => {
            if (win) {
              speak(
                "Selamat! Kamu telah menyelesaikan semua level. Sekarang fokus di tombol restart. Tekan enter untuk mulai lagi. Tekan tab untuk ke tombol kembali"
              );
            } else {
              speak(
                "Game over. Nyawa kamu habis. Sekarang fokus di tombol restart. Tekan enter untuk main lagi.  Tekan tab untuk ke tombol kembali"
              );
            }
          }, 500);

          // auto focus restart
          setTimeout(() => restartBtnFinish.focus(), 200);

          // speak on focus
          restartBtnFinish.addEventListener("focus", () => {
            speak(
              "Sekarang anda berada di Tombol restart. Tekan enter untuk memulai permainan lagi. Tekan tab untuk ke tombol kembali"
            );
          });
          backToMenuBtn.addEventListener("focus", () => {
            speak(
              "Sekarang anda berada di Tombol kembali ke menu. Tekan enter untuk kembali. Tekan tab untuk ke tombol Restart Game"
            );
          });

          // click / enter handlers
          restartBtnFinish.addEventListener("click", restartGame);
          restartBtnFinish.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              restartGame();
            }
          });
          backToMenuBtn.addEventListener("click", () => {
            stopSpeak();
            setTimeout(() => {
              window.location.href = "menu.html?mode=audio";
            }, 100);
          });

          backToMenuBtn.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              stopSpeak();
              setTimeout(() => {
                window.location.href = "menu.html?mode=audio";
              }, 100);
            }
          });

          // focus trap inside finishScreen (only two buttons)
          const focusable = [restartBtnFinish, backToMenuBtn];
          document
            .getElementById("finishScreen")
            .addEventListener("keydown", (e) => {
              if (e.key !== "Tab") return;
              e.preventDefault();
              let index = focusable.indexOf(document.activeElement);
              if (e.shiftKey) {
                index = index - 1;
                if (index < 0) index = focusable.length - 1;
              } else {
                index = index + 1;
                if (index >= focusable.length) index = 0;
              }
              focusable[index].focus();
            });
        }

        function restartGame() {
          stopSpeak();

          // Hapus status gameOver dari localStorage
          localStorage.removeItem("gameOver");

          // Restore state
          score = 0;
          lives = 3;
          level = 1;
          totalCorrect = 0;
          finishedGame = false;
          gameRunning = true;
          lastQuestion = null;

          // Rebuild game area
          gameArea.innerHTML = `
        <h2 id="instruction">Cari gambar yang sama</h2>
        <div id="targetImage"></div>
        <div id="gridContainer" class="grid"></div>
        <div id="feedback"></div>
      `;

          // Rebind local references
          targetImage = document.getElementById("targetImage");
          gridContainer = document.getElementById("gridContainer");
          feedbackDisplay = document.getElementById("feedback");

          // Update tampilan dan load ronde baru
          updateDisplay();
          loadRound(false);

          setTimeout(
            () => speak("Permainan diulang. Fokus ke pilihan gambar."),
            300
          );
        }

        // keyboard choice shortcuts (1..n)
        document.addEventListener("keydown", (e) => {
          if (!gameRunning) return;
          const choices = document.querySelectorAll(".choice");
          const { choicesKeys } = lastQuestion || {};
          if (
            choicesKeys &&
            e.key >= "1" &&
            e.key <= String(choicesKeys.length)
          ) {
            const index = parseInt(e.key) - 1;
            if (choices[index]) choices[index].click();
            else speak("Pilihan tidak tersedia");
          }
        });

        // stop audio on refresh
        window.addEventListener("beforeunload", () => {
          if ("speechSynthesis" in window) window.speechSynthesis.cancel();
        });
      });
      window.addEventListener("load", () => {
        window.scrollTo({ top: 0, behavior: "instant" });
      });
      function scrollToAfterHeader() {
        const target = document.getElementById("instruction");
        if (!target) return;

        const y = target.getBoundingClientRect().top + window.scrollY - 20;

        window.scrollTo({
          top: y,
          behavior: "smooth",
        });
      } // end DOMContentLoaded `
    </script>
  </body>
</html>
