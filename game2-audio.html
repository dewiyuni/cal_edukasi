<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jodohkan Gambar</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      :root {
        --primary-bg: #fef3c7;
        --header-bg: #ea580c;
        --accent-green: #38a169;
        --accent-yellow: #f6ad55;
        --display-blue: #3182ce;
        --font-inter: "Inter", sans-serif;
      }

      body {
        font-family: "Poppins", sans-serif;
        background: #fff7ed;
        margin: 5px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
      }

      .container {
        width: 100%;
        max-width: 1100px;
        margin: 0 auto;
        text-align: center;
        padding: 10px 20px;
        box-sizing: border-box;
      }

      .header-scene {
        position: relative;
        overflow: hidden;
        height: 120px;
        max-width: 900px;
        margin: 0 auto;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        text-align: center;
        color: white;
        padding: 20px;
      }

      .moving-bg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("img/bg header.png");
        background-repeat: repeat-x;
        background-size: 100%;
        background-position: 0 0;
        animation: moveBackground 25s linear infinite;
        z-index: 0;
      }

      @keyframes moveBackground {
        0% {
          background-position: 0 0;
        }
        100% {
          background-position: -1000px 0;
        }
      }

      main {
        background: white;
        padding: 20px;
        border-radius: 0 0 20px 20px;
        box-shadow: 1px 1px #fabb58;
        width: 100%;
        max-width: 940px;
        margin: 0 auto;
        box-sizing: border-box;
        position: relative;
      }

      .cashier-img {
        position: relative;
        z-index: 1;
        width: 120px;
        height: 120px;
        margin: 0 auto;
        background-color: #ff7b00;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        border: 4px solid #ff7b00;
      }

      .cashier-text {
        color: white;
        font-size: 18px;
        font-weight: bold;
        text-align: center;
        line-height: 1.2;
      }

      .title {
        font-size: 28px;
        font-weight: 800;
        color: #ff7b00;
        margin-bottom: 10px;
      }

      /* --- INFO BOX AWAL --- */
      .info-box {
        display: flex;
        justify-content: space-between;
        padding: 12px 15px;
        background: white;
        border: 3px solid #ffae42;
        border-radius: 15px;
        margin: 0 auto 20px;
        width: 85%;
        font-size: 18px;
        box-shadow: 4px 4px 0 #ffa726;
      }

      /* --- FLOATING INFO --- */
      #floatingInfo {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.8);
        padding: 8px 12px;
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
        gap: 15px;
        font-size: 14px;
        box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      #floatingInfo.visible {
        opacity: 1;
      }

      .start-container button {
        padding: 12px 18px;
        font-size: 18px;
        font-weight: bold;
        border-radius: 15px;
        border: 3px solid #ff9800;
        background: #fff3cd;
        box-shadow: 4px 4px 0 #ffa726;
        cursor: pointer;
        margin-bottom: 20px;
      }

      .start-container button:hover {
        background: #ffe28a;
        transform: scale(1.05);
        transition: 0.2s;
      }

      #gameArea {
        display: none;
        width: 100%;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 15px;
        margin-top: 20px;
        width: 100%;
      }

      .choice {
        background: white;
        border: 3px solid #ffa726;
        border-radius: 15px;
        padding: 10px;
        cursor: pointer;
        box-shadow: 4px 4px 0 #ffb74d;
        transition: 0.15s;
      }

      .choice:hover {
        transform: scale(1.07);
      }

      .choice img {
        width: 100%;
        height: 140px;
        object-fit: contain;
        margin: 20px auto 0 auto;
      }
      .choice:focus {
        outline: 4px solid blue;
      }

      #targetImage img {
        width: 40%;
        max-width: 300px;
        height: auto;
        object-fit: contain;
        display: block;
        margin: 12px auto;
        box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.3);
        border-radius: 10px;
      }
      .correct {
        border-color: #4ade80 !important;
        box-shadow: 4px 4px 0 #22c55e !important;
      }

      .wrong {
        animation: shake 0.3s;
        border-color: #ef4444 !important;
        box-shadow: 4px 4px 0 #dc2626 !important;
      }

      @keyframes shake {
        0% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        50% {
          transform: translateX(5px);
        }
        75% {
          transform: translateX(-5px);
        }
        100% {
          transform: translateX(0);
        }
      }

      #feedback {
        font-size: 24px;
        font-weight: bold;
        margin-top: 15px;
        min-height: 40px;
        line-height: 40px;
        padding: 5px 10px;
        border-radius: 10px;
        transition: all 0.3s ease;
        opacity: 0;
        transform: scale(0.8);
      }

      #feedback.correct {
        color: #22c55e;
        background: #d1fae5;
        border: 2px solid #22c55e;
        opacity: 1;
        transform: scale(1);
      }

      #feedback.wrong {
        color: #ef4444;
        background: #fee2e2;
        border: 2px solid #ef4444;
        opacity: 1;
        transform: scale(1);
        animation: shake 0.3s;
      }
      .back-btn {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.85);
        color: #ea580c;
        font-weight: bold;
        padding: 8px 14px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        border: none;
        cursor: pointer;
        z-index: 9999;
        transition: 0.2s;
      }
      .back-btn:hover {
        background: white;
        transform: scale(1.05);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- button back -->
      <button id="btnBack" class="back-btn">
        <i class="fas fa-arrow-left"></i>
      </button>

      <!-- Header -->
      <header class="header-scene">
        <div class="moving-bg"></div>
        <div class="moving-bg"></div>
        <div class="cashier-img">
          <span class="cashier-text">Uang<br />Match</span>
        </div>
      </header>

      <main>
        <h1 class="title">Menjodohkan Gambar üç±‚ú®</h1>

        <!-- INFO BOX AWAL -->
        <div class="info-box" id="judulGame">
          <p>Skor: <span id="score">0</span></p>
          <p>Nyawa: <span id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></p>
          <p>Level: <span id="level">1</span></p>
        </div>

        <!-- FLOATING INFO -->
        <div id="floatingInfo">
          <p>Skor: <span id="scoreFloat">0</span></p>
          <p>Nyawa: <span id="livesFloat">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></p>
          <p>Level: <span id="levelFloat">1</span></p>
        </div>

        <div class="start-container">
          <button id="startBtn" tabindex="0" aria-label="Mulai Permainan">
            Mulai Permainan
          </button>
        </div>

        <div id="gameArea">
          <h2 id="instruction">cari gambar dengan harga yang sama</h2>
          <div id="targetImage"></div>
          <div id="gridContainer" class="grid"></div>
        </div>
        <div id="finishScreen" style="display: none"></div>

        <div id="feedback"></div>
        <p id="sr-only" style="position: absolute; left: -9999px"></p>
      </main>
    </div>

    <script>
      let allowVoice = true;
      let finishedGame = false;
      let totalCorrect = 0;
      let lastQuestion = null;

      // ================== MODE & SPEECH ==================
      function isAudioMode() {
        return localStorage.getItem("gameMode") === "audio";
      }

      function stopSpeak() {
        if ("speechSynthesis" in window) {
          window.speechSynthesis.cancel();
        }
      }

      let isSpeaking = false;

      // ================== DATA ==================
      const moneyImages = {
        1000: "img/1000.png",
        2000: "img/2000.png",
        5000: "img/5000.png",
        10000: "img/10000.png",
        20000: "img/20000.png",
        50000: "img/50000.png",
        100000: "img/100000.png",
      };

      const itemImages = {
        1000: [
          { src: "img/permen.jpg", label: "Permen" },
          { src: "img/ballon.png", label: "Balon" },
          { src: "img/pensil-mini.png", label: "Pensil Mini" },
        ],
        2000: [
          { src: "img/bengbeng.jpeg", label: "Beng-beng" },
          { src: "img/nabati.jpeg", label: "Nabati" },
          { src: "img/tango.jpeg", label: "Tango" },
          { src: "img/penghapus.jpeg", label: "Penghapus" },
        ],
        5000: [
          { src: "img/coklat.png", label: "Coklat" },
          { src: "img/chikitwist.jpeg", label: "Chiki Twist" },
          { src: "img/ultramilk.jpeg", label: "Ultra Milk" },
          { src: "img/ganci.jpeg", label: "Gantungan Kunci" },
          { src: "img/gelang.png", label: "Gelang" },
          { src: "img/jepit.jpg", label: "Jepit Rambut" },
        ],
        10000: [
          { src: "img/cake.jpg", label: "Kue" },
          { src: "img/frenchfries.jpeg", label: "Kentang Goreng" },
          { src: "img/nescafe.jpeg", label: "Nescafe" },
          { src: "img/kaoskaki.jpeg", label: "Kaos Kaki" },
        ],
        20000: [
          { src: "img/botol.jpeg", label: "Botol Minum" },
          { src: "img/topi.jpg", label: "Topi" },
          { src: "img/sendal.jpeg", label: "Sandal" },
        ],
        50000: [
          { src: "img/boneka.png", label: "Boneka" },
          { src: "img/jashujan.jpeg", label: "Jas Hujan" },
          { src: "img/tas.png", label: "Tas" },
        ],
        100000: [
          { src: "img/mobil.jpeg", label: "Mobil Mainan" },
          { src: "img/sepatu.jpeg", label: "Sepatu" },
        ],
      };

      function formatRupiahText(value) {
        switch (Number(value)) {
          case 1000:
            return "1 ribu rupiah";
          case 2000:
            return "2 ribu rupiah";
          case 5000:
            return "5 ribu rupiah";
          case 10000:
            return "10 ribu rupiah";
          case 20000:
            return "20 ribu rupiah";
          case 50000:
            return "50 ribu rupiah";
          case 100000:
            return "100 ribu rupiah";
          default:
            return `${Number(value).toLocaleString()} rupiah`;
        }
      }

      // ================== GAME STATE ==================
      let score = 0,
        level = 1,
        lives = 3,
        gameRunning = false;

      const scoreDisplay = document.getElementById("score");
      const livesDisplay = document.getElementById("lives");
      const levelDisplay = document.getElementById("level");
      const startBtn = document.getElementById("startBtn");
      const targetImage = document.getElementById("targetImage");
      const gridContainer = document.getElementById("gridContainer");
      const gameArea = document.getElementById("gameArea");
      const feedbackDisplay = document.getElementById("feedback");
      const restartBtn = document.getElementById("restartBtn");

      let currentAudio = null;

      // ================== AUDIO & TTS ==================
      function stopAllSound() {
        stopSpeak();
        if (currentAudio) {
          currentAudio.pause();
          currentAudio.currentTime = 0;
          currentAudio = null;
        }
      }

      function playAudio(src) {
        return new Promise((resolve) => {
          stopAllSound();
          const audio = new Audio(src);
          currentAudio = audio;
          audio.volume = 1;
          audio.onended = resolve;
          audio.onerror = resolve;
          audio.play().catch(() => resolve());
        });
      }

      function speakAsync(text) {
        return new Promise((resolve) => {
          stopAllSound();
          const utter = new SpeechSynthesisUtterance(text);
          utter.lang = "id-ID";
          utter.rate = 0.9;
          utter.pitch = 1;
          utter.onend = resolve;
          window.speechSynthesis.speak(utter);
        });
      }

      // ================== START GAME ==================
      function startGame() {
        score = 0;
        level = 1;
        lives = 3;
        totalCorrect = 0;
        gameRunning = true;
        finishedGame = false;
        lastQuestion = null;

        updateDisplay();
        loadRound();
      }

      function updateDisplay() {
        scoreDisplay.textContent = score;
        levelDisplay.textContent = level;
        livesDisplay.textContent = "‚ù§Ô∏è".repeat(lives);
      }
      function refreshGameElements() {
        window.targetImage = document.getElementById("targetImage");
        window.gridContainer = document.getElementById("gridContainer");
        window.feedbackDisplay = document.getElementById("feedback");
      }

      // ================== GAME ROUND ==================
      async function loadRound(repeat = false) {
        refreshGameElements();
        if (!gameRunning || finishedGame) return;
        stopAllSound();

        if (!repeat) {
          const keys = Object.keys(moneyImages);
          const correctKey = keys[Math.floor(Math.random() * keys.length)];
          currentAnswer = correctKey;

          const otherKeys = keys.filter((k) => k !== correctKey);
          const choicesKeys = otherKeys
            .sort(() => Math.random() - 0.5)
            .slice(0, 2);
          choicesKeys.push(correctKey);
          choicesKeys.sort(() => Math.random() - 0.5);

          lastQuestion = { correctKey, choicesKeys };
        }

        const { correctKey, choicesKeys } = lastQuestion;
        targetImage.innerHTML = `<img src="${moneyImages[correctKey]}" alt="uang ${correctKey}" />`;
        gridContainer.innerHTML = "";

        const choiceItems = [];

        for (let index = 0; index < choicesKeys.length; index++) {
          const key = choicesKeys[index];
          const items = itemImages[key];
          const randomItem = items[Math.floor(Math.random() * items.length)];
          choiceItems.push({ key, randomItem });

          const div = document.createElement("div");
          div.className = "choice";
          div.setAttribute("tabindex", "0");
          div.setAttribute(
            "aria-label",
            `Pilihan ${index + 1}: ${
              randomItem.label
            }, harga ${formatRupiahText(key)}`
          );
          div.innerHTML = `
                              <img src="${randomItem.src}" alt="${
            randomItem.label
          }">
                              <p style="margin-top:8px; font-weight:bold; font-size:16px; color:#ff7b00;">
                                Rp ${Number(key).toLocaleString()}
                              </p>
                            `;
          div.addEventListener("click", () =>
            handleChoice(div, key, correctKey)
          );
          div.addEventListener("keydown", (e) => {
            if (e.key === "Enter") div.click();
          });
          gridContainer.appendChild(div);
        }
        // ================== PILIH PAKAI ANGKA 1,2,3 ==================
        document.onkeydown = function (e) {
          if (!gameRunning) return;
          // angka 1,2,3 di keyboard atas (kode 'Digit1','Digit2','Digit3')
          // atau numpad (Numpad1, Numpad2, Numpad3)
          let keyIndex = -1;
          if (e.code === "Digit1" || e.code === "Numpad1") keyIndex = 0;
          else if (e.code === "Digit2" || e.code === "Numpad2") keyIndex = 1;
          else if (e.code === "Digit3" || e.code === "Numpad3") keyIndex = 2;

          if (keyIndex !== -1) {
            e.preventDefault();
            const choiceDiv = gridContainer.children[keyIndex];
            if (choiceDiv) {
              choiceDiv.click();
            }
          }
        };

        if (isAudioMode()) {
          await playAudio("audio/match_audio/cari_barang.mp3");
          await speakAsync(formatRupiahText(correctKey));

          // Audio & TTS tiap pilihan
          for (let i = 0; i < choiceItems.length; i++) {
            const { key, randomItem } = choiceItems[i];
            await playAudio(`audio/match_audio/pilihan${i + 1}.mp3`);
            await speakAsync(`${i + 1}. ${randomItem.label}`);
            await playAudio("audio/match_audio/harga.mp3");
            await speakAsync(formatRupiahText(key));
          }
          await playAudio("audio/match_audio/tombol.mp3");
        }
      }

      // ================== HANDLE CHOICE ==================
      function handleChoice(div, selected, correct) {
        if (!gameRunning) return;
        stopAllSound();
        allowVoice = false;

        if (selected === correct) {
          div.classList.add("correct");
          feedbackDisplay.textContent = "‚úÖ Benar!";
          feedbackDisplay.className = "correct";

          score += 1;
          totalCorrect++;
          updateDisplay();

          // CEK kalau sudah selesai game
          let isFinalWin = false;
          if (level === 1 && totalCorrect >= 3) level = 2;
          else if (level === 2 && totalCorrect >= 5) level = 3;
          else if (level === 3 && totalCorrect >= 7) isFinalWin = true;

          if (isAudioMode()) {
            playAudio("audio/match_audio/benar.mp3").then(() => {
              // ======== KALAU SUDAH MENANG ========
              if (isFinalWin) {
                finishedGame = true;
                gameRunning = false;
                showFinishScreen(true); // ‚Üê audio selamat pasti bunyi
                return;
              }

              // ======== LANJUT ROUND NORMAL ========
              feedbackDisplay.textContent = "";
              feedbackDisplay.className = "";
              loadRound(false);
            });
          } else {
            setTimeout(() => {
              if (isFinalWin) {
                finishedGame = true;
                gameRunning = false;
                showFinishScreen(true);
                return;
              }

              feedbackDisplay.textContent = "";
              feedbackDisplay.className = "";
              loadRound(false);
            }, 800);
          }
        } else {
          div.classList.add("wrong");
          feedbackDisplay.textContent = "‚ùå Salah";
          feedbackDisplay.className = "wrong";
          lives--;
          updateDisplay();

          if (isAudioMode()) playAudio("audio/match_audio/salah.mp3");

          if (lives <= 0) {
            finishedGame = true;
            gameRunning = false;
            feedbackDisplay.textContent = "üíÄ Permainan berakhir!";
            showFinishScreen(false);
            return;
          }

          setTimeout(() => {
            feedbackDisplay.textContent = "";
            feedbackDisplay.className = "";
            loadRound(true);
          }, 1200);
        }
      }

      // ================== LEVEL UP ==================
      function checkLevelUp() {
        if (level === 1 && totalCorrect >= 3) level = 2;
        else if (level === 2 && totalCorrect >= 5) level = 3;
        else if (level === 3 && totalCorrect >= 7) {
          finishedGame = true;
          gameRunning = false;
          stopAllSound();
          showFinishScreen(true);
        }
      }

      // ============= set focus restart dan kembali ==================
      function setFinishFocus() {
        const restartBtn = document.getElementById("restartBtnFinish");
        const backMenuBtn = document.getElementById("backMenuBtn");

        if (!restartBtn || !backMenuBtn) return;

        // Fokus awal ke restart
        restartBtn.focus();

        // --- AUDIO SAAT FOKUS RESTART ---
        restartBtn.addEventListener("focus", () => {
          playAudio("audio/match_audio/restart.mp3");
        });

        // --- AUDIO SAAT FOKUS BACK ---
        backMenuBtn.addEventListener("focus", () => {
          playAudio("audio/match_audio/kembali.mp3");
        });

        // Navigasi panah antara dua tombol
        restartBtn.addEventListener("keydown", (e) => {
          if (e.key === "Tab") {
            e.preventDefault();
            backMenuBtn.focus();
          }
        });

        backMenuBtn.addEventListener("keydown", (e) => {
          if (e.key === "Tab") {
            e.preventDefault();
            restartBtn.focus();
          }
        });

        // Kunci fokus agar tidak kabur
        document.addEventListener("focusin", (e) => {
          if (finishedGame) {
            if (e.target !== restartBtn && e.target !== backMenuBtn) {
              restartBtn.focus();
            }
          }
        });
      }

      // ====restart =====
      function restartGame() {
        stopAllSound();

        const finishScreen = document.getElementById("finishScreen");

        finishScreen.style.display = "none"; // sembunyikan tampilan tamat
        gameArea.style.display = "block"; // tampilkan kembali game

        score = 0;
        level = 1;
        lives = 3;
        totalCorrect = 0;
        finishedGame = false;
        gameRunning = true;

        updateDisplay();

        targetImage.innerHTML = "";
        gridContainer.innerHTML = "";
        feedbackDisplay.textContent = "";
        feedbackDisplay.style.display = "none";

        loadRound(false);
      }

      // ================== FINISH SCREEN ==================
      function showFinishScreen(win = true) {
        gameArea.style.display = "none";
        const finishScreen = document.getElementById("finishScreen");
        finishScreen.style.display = "block";

        finishScreen.innerHTML = `
    <div style="text-align:center; padding:20px;">
      <h2>${win ? "üéâ Selamat!" : "üíÄ Game Over"}</h2>
      <p>${
        win
          ? "Anda telah menyelesaikan level tertinggi"
          : "Nyawa habis, coba lagi ya!"
      }</p>

      <button id="restartBtnFinish"
        style="margin-top:20px; padding:12px 20px; font-size:18px;
        border-radius:12px; background:#fb923c; color:white; border:none;">
        üîÑ Restart Game
      </button>

      <button id="backMenuBtn"
        style="margin-top:20px; padding:12px 20px; font-size:18px;
        border-radius:12px; background:#6b7280; color:white; border:none;">
        ‚¨ÖÔ∏è Kembali ke Menu Awal
      </button>
    </div>
  `;

        const restartBtn = document.getElementById("restartBtnFinish");
        const backMenuBtn = document.getElementById("backMenuBtn");

        restartBtn.onclick = () => restartGame();
        backMenuBtn.onclick = () =>
          (window.location.href = "menu.html?mode=audio");

        setFinishFocus();

        async function finishAudio() {
          if (isAudioMode()) {
            if (win) await playAudio("audio/match_audio/selamat.mp3");
            else await playAudio("audio/match_audio/gagal.mp3");
          }

          setTimeout(() => restartBtn.focus(), 150);
        }

        finishAudio();
      }

      // ================== START BUTTON ==================
      window.addEventListener("load", async () => {
        await playAudio("audio/match_audio/awal.mp3");
        startBtn.focus();
        await playAudio("audio/match_audio/mulai.mp3");
      });
      startBtn.addEventListener("click", async () => {
        startBtn.style.display = "none";
        gameArea.style.display = "block";
        refreshGameElements();
        startGame();
        setTimeout(() => {
          scrollToAfterHeader();
        }, 200);
      });

      // ================== BACK BUTTON ==================
      document.getElementById("btnBack").addEventListener("click", () => {
        const mode = localStorage.getItem("gameMode") || "audio";
        window.location.href = `menu.html?mode=${mode}`;
      });

      // ================== LOAD ==================
      window.addEventListener("load", () => {
        window.scrollTo({ top: 0, behavior: "instant" });
      });
      window.addEventListener("beforeunload", () => {
        if ("speechSynthesis" in window) window.speechSynthesis.cancel();
      });

      function scrollToAfterHeader() {
        const target = document.getElementById("instruction");
        if (!target) return;

        const y = target.getBoundingClientRect().top + window.scrollY - 20;

        window.scrollTo({
          top: y,
          behavior: "smooth",
        });
      }
    </script>
  </body>
</html>
