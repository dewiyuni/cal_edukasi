<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kasir Kelma - Belajar Uang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome untuk ikon loading -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      :root {
        --primary-bg: #fef3c7; /* Kuning Muda - Latar Belakang Tubuh */
        --header-bg: #ea580c; /* Oranye Terang - Warna Header Overlay */
        --accent-green: #38a169; /* Hijau - Untuk Harga/Sukses */
        --accent-yellow: #f6ad55; /* Kuning - Untuk Tombol Uang */
        --display-blue: #3182ce; /* Biru - Untuk Display Total */
        --font-inter: "Inter", sans-serif;
      }
      body {
        font-family: var(--font-inter);
        background-color: var(--primary-bg);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
      }
      /* --- KOTAK KASIR --- */
      .kasir-container {
        background-color: #ffffff;
        border-radius: 20px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2),
          0 8px 10px -6px rgba(0, 0, 0, 0.1);
        max-width: 900px;
        width: 100%;
        overflow: hidden;
        display: grid;
        grid-template-rows: auto 1fr;
      }

      /* --- HEADER SCENE --- */
      .header-scene {
        background-color: #fabb58;
        color: white;
        padding: 20px;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        text-align: center;
        position: relative;
        overflow: hidden;
        height: 160px;
      }

      /* --- ANIMASI BACKGROUND (opsional) --- */
      @keyframes moveBackground {
        0% {
          background-position: 0 0;
        }
        100% {
          background-position: -600px 0;
        }
      }

      .header-scene::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-repeat: repeat-x;
        background-size: auto 100%; /* <<< fix gambar membesar */
        background-position: 0 0;
        animation: moveBackground 25s linear infinite;
        opacity: 0.5;
        z-index: 0;
      }

      /* --- KONTEN DI DEPAN --- */
      .scene-content {
        position: relative;
        z-index: 2;
        text-align: center;
      }
      .cashier-img {
        background-image: url("https://placehold.co/80x80/ffffff/000000?text=K A S I R%0AK E L M A&font-size=20");
        background-size: cover;
        border-radius: 50%;
        border: 4px solid rgb(255, 255, 255);
        width: 110px;
        height: 110px;
        margin: 0 auto 10px;
      }
      /* Kontainer bergerak */
      .moving-items {
        position: absolute;
        top: 40%;
        left: 0;
        width: 200vw; /* WAJIB biar mulus! */
        height: auto;
        display: flex;
        gap: 0px;
        z-index: 1;

        /* Remove translateY dari sini */
        animation: moveItems 20s linear infinite;
      }

      /* Gambar */
      .moving-item {
        width: 100vw;
        height: auto;
        border-radius: 0;
        object-fit: cover;
        transform: translateY(-50%);
      }
      @keyframes moveItems {
        0% {
          transform: translateX(0);
        }
        100% {
          transform: translateX(-100vw);
        }
      }
      /* back  */
      .back-btn {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.85);
        color: #ea580c; /* oranye biar cocok sama header */
        font-weight: bold;
        padding: 8px 14px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        border: none;
        cursor: pointer;
        z-index: 9999;
        transition: 0.2s;
      }

      .back-btn:hover {
        background: white;
        transform: scale(1.05);
      }

      /* --- ITEM ROW (opsional, statis di bawah kasir) --- */
      .item-row {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
        z-index: 2;
      }

      .item-img {
        width: 150px;
        height: auto;
        border-radius: 10px;
      }

      /* Layout Tombol Uang */
      #moneyButtons {
        display: grid;
        grid-template-columns: repeat(4, 1fr); /* DESKTOP = 4 kolom */
        gap: 15px;
      }

      /* Tombol Denominasi */
      .money-btn {
        font-weight: 700;
        transition: transform 0.1s, box-shadow 0.1s;
        box-shadow: 0 4px rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        padding: 10px;
        height: 150px;
      }
      .money-btn:active {
        transform: translateY(2px);
        box-shadow: 0 2px rgba(0, 0, 0, 0.2);
      }

      /* Gambar Uang */
      .money-btn img,
      .note-img {
        width: 100%;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        display: block;
      }

      /* RESPONSIVE: HP ‚Üí 2 kolom */
      @media (max-width: 768px) {
        #moneyButtons {
          grid-template-columns: repeat(2, 1fr); /* HP = 2 kolom */
        }

        .money-btn {
          height: 170px;
        }

        .money-btn img,
        .note-img {
          height: 120px;
        }
      }
      /* Efek pop */
      #btnPlus {
        transition: transform 0.15s ease;
      }

      #btnPlus.clicked {
        transform: scale(0.92);
      }

      /* Tombol Aksi */
      .action-btn {
        font-size: 1.5rem;
        font-weight: 800;
        color: white;
        transition: background-color 0.1s;
        box-shadow: 0 4px rgba(0, 0, 0, 0.3);
      }
      .action-btn:active {
        transform: translateY(2px);
        box-shadow: 0 2px rgba(0, 0, 0, 0.3);
      }
      .btn-plus {
        background-color: #fabb58;
        box-shadow: 0 4px #929292;
      }
      .btn-bayar {
        background-color: rgb(187, 115, 28); /* merah */
        color: rgb(255, 255, 255);
      }

      .btn-plus:active {
        box-shadow: 0 2px #2f855a;
      }
      .btn-minus {
        background-color: #e53e3e; /* Merah */
        box-shadow: 0 4px #c53030;
      }
      .btn-minus:active {
        box-shadow: 0 2px #c53030;
      }
      .btn-equals {
        background-color: var(--accent-green);
        box-shadow: 0 4px #2f855a;
      }
      .btn-equals:active {
        box-shadow: 0 2px #2f855a;
      }
      /* Loading Spinner */
      .loading-spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 4px solid white;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      /* Tombol Scroll to Top */
      #scrollTopBtn {
        position: fixed; /* tetap di posisi layar */
        bottom: 20px; /* jarak dari bawah */
        right: 20px; /* jarak dari kanan */
        width: 50px;
        height: 50px;
        background-color: rgb(187, 115, 28); /* warna tombol */
        color: white;
        border: none;
        border-radius: 50%; /* buat bulat */
        display: none; /* default tersembunyi */
        justify-content: center;
        align-items: center;
        cursor: pointer;
        z-index: 1000; /* supaya selalu di atas */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
      }

      #scrollTopBtn:hover {
        background-color: rgb(237, 148, 39); /* warna saat hover */
        transform: translateY(-2px);
      }

      #floatingTotal {
        position: fixed;
        bottom: 16px;
        left: 50%; /* posisinya di tengah layar */
        transform: translateX(-50%); /* geser ke kiri setengah lebarnya */
        width: 300px; /* ganti sesuai kebutuhan */
        z-index: 9999;
      }
    </style>
  </head>
  <body>
    <div class="kasir-container">
      <!-- button back -->
      <button id="btnBack" class="back-btn">
        <i class="fas fa-arrow-left"></i>
      </button>
      <!-- Header: Warung Jajanan Anime & Kasir -->
      <header class="header-scene" id="headerScene">
        <div class="scene-content">
          <div class="cashier-img"></div>
        </div>

        <div class="moving-items">
          <img src="img/header.jpg" alt="header" class="moving-item" />
          <img src="img/header.jpg" alt="header" class="moving-item" />
        </div>
      </header>

      <!-- Konten Utama: Display Harga & Tombol Uang -->
      <main class="p-6">
        <div class="flex gap-3 w-full mb-4">
          <!-- Tombol Pilih Jajan -->
          <button
            id="btnPlus"
            class="action-btn btn-plus flex-[4] p-5 rounded-2xl flex items-center justify-center font-bold text-lg shadow-md hover:scale-[1.02] active:scale-[0.98] transition"
          >
            <span id="plusText">Pilih 1 jajan ‚ú®</span>
            <div id="plusLoading" class="loading-spinner hidden ml-2"></div>
          </button>

          <!-- Tombol Keranjang -->
          <button
            id="btnAddToCart"
            class="flex-[1] bg-green-600 text-white rounded-2xl flex items-center justify-center font-bold text-2xl shadow-md hover:bg-green-700 hover:scale-[1.05] active:scale-[0.95] transition h-[64px]"
            aria-label="Tambahkan ke keranjang"
            title="Tambah ke keranjang"
          >
            üõí
          </button>
        </div>

        <!-- Display Nama Barang & Harga & Quantity -->
        <div
          class="bg-gray-100 p-4 rounded-lg mb-4 border-2 border-dashed border-gray-400"
        >
          <div
            id="itemGambarDisplay"
            class="block mx-auto w-40 h-32 md:w-72 md:h-56 bg-gray-100 border border-gray-300 rounded-lg flex items-center justify-center overflow-hidden shadow"
          ></div>
          <p class="text-lg font-semibold text-gray-700">Nama Item Jajanan:</p>
          <div
            id="itemNameDisplay"
            class="text-2xl font-bold text-gray-800 p-2 rounded-lg text-center bg-white mb-4"
          >
            Tekan "Pilih Jajan"
          </div>

          <!-- Quantity Control Baru -->
          <div class="flex items-center justify-between mt-2 mb-4">
            <div class="text-lg font-semibold text-gray-700">Jumlah Item:</div>
            <div class="flex items-center space-x-3">
              <button
                id="btnQuantityMinus"
                class="text-2xl font-bold bg-red-500 hover:bg-red-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg transition duration-150 disabled:opacity-50"
                disabled
              >
                -
              </button>
              <span
                id="quantityDisplay"
                class="text-3xl font-extrabold text-gray-800 w-10 text-center"
                >0</span
              >
              <button
                id="btnQuantityPlus"
                class="text-2xl font-bold bg-green-500 hover:bg-green-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg transition duration-150 disabled:opacity-50"
                disabled
              >
                +
              </button>
            </div>
          </div>

          <p class="text-lg font-semibold text-gray-700 mt-2">
            Total Harga Belanjaan:
          </p>

          <!-- Total Price Display -->
          <div
            id="itemPriceDisplay"
            class="text-4xl font-extrabold text-[#f38229] bg-white p-3 rounded-xl shadow-lg mt-1 text-center"
          >
            Rp 0
          </div>
          <button
            id="btnProceedPayment"
            disabled
            class="bg-blue-500 text-white p-3 rounded-lg w-full mb-4 hidden"
          >
            Lanjut ke Bayar
          </button>
        </div>
        <div id="cartDisplay" class="bg-white p-3 rounded-lg mb-4 border">
          <p
            class="font-bold mb-2 text-lg text-gray-700 flex items-center gap-2"
          >
            Keranjang üõí
          </p>
          <div class="overflow-x-auto bg-white rounded-xl shadow-md">
            <table class="w-full text-sm text-left border-collapse">
              <thead>
                <tr class="bg-gray-100 text-gray-600 uppercase text-xs">
                  <th class="p-3">Barang</th>
                  <th class="p-3 text-center">Qty</th>
                  <th class="p-3 text-right">Harga</th>
                  <th class="p-3 text-right">Subtotal</th>
                </tr>
              </thead>
              <tbody id="cartList"></tbody>
            </table>
          </div>

          <button
            id="btnNext"
            class="action-btn btn-bayar w-full p-4 mb-3 mt-3 rounded-xl flex items-center justify-center"
          >
            <span>Bayar</span>
            <div id="plusLoading" class="loading-spinner hidden ml-2"></div>
          </button>
          <button id="scrollTopBtn">‚Üë</button>
        </div>
        <!-- Display Uang Pembayaran (Uang yang dimasukkan) -->
        <div class="bg-display-blue p-4 rounded-lg mb-6 shadow-xl">
          <p class="text-xl font-bold text-black mb-2" id="sectionUang">
            Total Uang Dibayar:
          </p>
          <div
            id="paymentDisplay"
            class="text-5xl font-extrabold text-accent-yellow bg-white p-3 rounded-xl text-center"
          >
            Rp 0
          </div>
        </div>

        <!-- Tombol Denominasi Uang -->
        <div class="text-center mb-6">
          <p class="text-lg font-semibold mb-3 text-gray-800">
            Tekan Uang yang Kamu Bayarkan:
          </p>
          <div id="moneyButtons">
            <!-- Denominasi Uang akan di-generate di sini dalam bentuk gambar placeholder yang realistis -->
          </div>
        </div>

        <!-- Tombol Aksi (Kurang/Reset Pembayaran, Tambah/Harga Baru, Sama Dengan/Hitung Kembalian) -->
        <div class="flex space-x-3">
          <button
            id="btnMinus"
            class="action-btn btn-minus w-1/2 p-2 rounded-xl"
          >
            <span class="block text-2xl mb-1">Ulangi</span>
            <span class="text-sm font-normal">(Reset Pembayaran)</span>
          </button>

          <button
            id="btnEquals"
            class="action-btn btn-equals w-1/2 p-2 rounded-xl flex flex-col items-center justify-center"
          >
            <span class="block text-2xl mb-1">Hitung Kembalian</span>
            <span class="text-sm font-normal"></span>
          </button>
        </div>

        <!-- Display Kembalian/Pesan & Play Audio Button -->
        <div id="messageContainer" class="mt-6">
          <div
            id="messageBox"
            class="p-4 rounded-lg text-center font-bold text-lg hidden"
          >
            <!-- Pesan Kembalian akan muncul di sini -->
          </div>
          <div class="mt-2 text-center">
            <button
              id="btnPlayAudio"
              class="bg-[#FABB58] hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-full hidden items-center"
              disabled
            >
              <i class="fas fa-volume-up mr-2"></i>
              <span id="playAudioText">Kasir Bicara</span>
              <div id="audioLoading" class="loading-spinner ml-2 hidden"></div>
            </button>
          </div>
        </div>
      </main>
    </div>
    <!-- Popup Total Harga -->
    <div
      id="floatingTotal"
      class="fixed bottom-4 left-4 right-4 bg-green-600 text-white p-4 rounded-2xl shadow-xl text-center font-bold text-lg hidden z-50"
    >
      Total: <span id="floatingTotalText">Rp 0</span>
    </div>

    <script type="module">
      // --- KONSTANTA & SETUP API GEMINI ---
      const API_KEY = ""; // Kunci API akan disediakan oleh runtime
      const GENERATE_CONTENT_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
      const GENERATE_TTS_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;

      // Data Denominasi, Pahlawan, Warna, dan Bentuk (Visual Uang Nyata)
      // Data Uang: koin dan uang kertas
      const heroData = {
        100: {
          name: "Koin 100 Rupiah",
          shape: "coin",
          img: "img/100.png",
          color: "FFD700",
          text: "100",
        },
        200: {
          name: "Koin 200 Rupiah",
          shape: "coin",
          img: "img/200.png",
          color: "FFD700",
          text: "200",
        },
        500: {
          name: "Koin 500 Rupiah",
          shape: "coin",
          img: "img/500.png",
          color: "FFD700",
          text: "500",
        },
        1000: {
          name: "1 Ribu Rupiah",
          shape: "note",
          img: "img/1000.png",
          color: "388E3C",
          text: "1000",
        },
        2000: {
          name: "2 Ribu Rupiah",
          shape: "note",
          img: "img/2000.png",
          color: "8D6E63",
          text: "2000",
        },
        5000: {
          name: "5 Ribu Rupiah",
          shape: "note",
          img: "img/5000.png",
          color: "FFC107",
          text: "5000",
        },
        10000: {
          name: "10 Ribu Rupiah",
          shape: "note",
          img: "img/10000.png",
          color: "1976D2",
          text: "10000",
        },
        20000: {
          name: "20 Ribu Rupiah",
          shape: "note",
          img: "img/20000.png",
          color: "2E7D32",
          text: "20000",
        },
        50000: {
          name: "50 Ribu Rupiah",
          shape: "note",
          img: "img/50000.png",
          color: "512DA8",
          text: "50000",
        },
        100000: {
          name: "100 Ribu Rupiah",
          shape: "note",
          img: "img/100000.png",
          color: "C2185B",
          text: "100000",
        },
      };
      const denominations = Object.keys(heroData).map(Number); // Mengambil array nilai [100, 200, ...]

      // Elemen DOM
      const itemNameDisplay = document.getElementById("itemNameDisplay");
      const itemPriceDisplay = document.getElementById("itemPriceDisplay");
      const paymentDisplay = document.getElementById("paymentDisplay");
      const moneyButtonsContainer = document.getElementById("moneyButtons");
      const btnMinus = document.getElementById("btnMinus");
      const btnPlus = document.getElementById("btnPlus");
      const btnEquals = document.getElementById("btnEquals");
      const messageBox = document.getElementById("messageBox");
      const btnPlayAudio = document.getElementById("btnPlayAudio");
      const plusLoading = document.getElementById("plusLoading");
      const plusText = document.getElementById("plusText");
      const audioLoading = document.getElementById("audioLoading");
      const playAudioText = document.getElementById("playAudioText");
      // Elemen DOM baru untuk kontrol kuantitas
      const quantityDisplay = document.getElementById("quantityDisplay");
      const btnQuantityMinus = document.getElementById("btnQuantityMinus");
      const btnQuantityPlus = document.getElementById("btnQuantityPlus");

      // State Aplikasi (Diperbarui untuk mengakomodasi kuantitas)
      let basePrice = 0; // Harga dasar per unit (Rp)
      let itemQuantity = 0; // Jumlah unit
      let itemPrice = 0; // Total Harga yang harus dibayar (basePrice * itemQuantity)
      let totalPaid = 0; // Uang yang sudah dibayarkan oleh anak
      let audioContext;
      let audioSource;

      // --- HELPER FUNCTIONS (API & Audio) ---

      function base64ToArrayBuffer(base64) {
        const binaryString = atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
      }

      function pcmToWav(pcm16, sampleRate) {
        const numChannels = 1;
        const bitDepth = 16;
        const bytesPerSample = bitDepth / 8;
        const blockAlign = numChannels * bytesPerSample;
        const byteRate = sampleRate * blockAlign;
        const dataSize = pcm16.length * bytesPerSample;
        const buffer = new ArrayBuffer(44 + dataSize);
        const view = new DataView(buffer);

        function writeString(view, offset, string) {
          for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
          }
        }

        writeString(view, 0, "RIFF");
        view.setUint32(4, 36 + dataSize, true);
        writeString(view, 8, "WAVE");
        writeString(view, 12, "fmt ");
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, numChannels, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, byteRate, true);
        view.setUint16(32, blockAlign, true);
        view.setUint16(34, bitDepth, true);
        writeString(view, 36, "data");
        view.setUint32(40, dataSize, true);

        let offset = 44;
        for (let i = 0; i < pcm16.length; i++, offset += 2) {
          view.setInt16(offset, pcm16[i], true);
        }

        return new Blob([view], { type: "audio/wav" });
      }

      async function callApiWithRetry(url, payload, maxRetries = 5) {
        for (let attempt = 0; attempt < maxRetries; attempt++) {
          try {
            const response = await fetch(url, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            if (response.status === 429 && attempt < maxRetries - 1) {
              const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
              await new Promise((resolve) => setTimeout(resolve, delay));
              continue;
            }
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
          } catch (error) {
            if (attempt === maxRetries - 1) throw error;
          }
        }
      }
      const btnProceedPayment = document.getElementById("btnProceedPayment");

      btnProceedPayment.addEventListener("click", () => {
        moneyButtonsContainer.classList.remove("hidden");
        moneyButtonsContainer.innerHTML = ""; // Kosongkan dulu

        denominations.forEach((value) => {
          const btn = document.createElement("button");
          const data = heroData[value];
          btn.innerHTML = `<img src="${data.img}" alt="${data.name}"/>
                                     <span style="font-size:0.7rem;display:block;text-align:center;">${data.name}</span>`;
          btn.classList.add("money-btn");
          btn.style.display = "flex";
          btn.style.flexDirection = "column";
          btn.style.alignItems = "center";
          btn.style.justifyContent = "center";
          btn.style.margin = "5px";
          btn.style.padding = "5px";
          btn.style.height = "160px";
          btn.addEventListener("click", () => {
            totalPaid += value;
            const remaining = itemPrice - totalPaid;
            if (remaining > 0) {
              playVerbalFeedback(
                `Kamu memasukkan ${formatRupiah(
                  value
                )}. Sisa bayar ${formatRupiah(remaining)}.`
              );
            } else {
              const change = Math.abs(remaining);
              playVerbalFeedback(
                `Kamu membayar ${formatRupiah(totalPaid)}. ${
                  change > 0 ? `Kembalian ${formatRupiah(change)}.` : ""
                } Transaksi selesai!`
              );

              // Reset dan kembali ke menu awal
              setTimeout(() => {
                startGame(); // kembalikan ke awal
              }, 1500); // kasih jeda 1,5 detik supaya user sempat dengar feedback
            }
          });
          btn.addEventListener("focus", () => {
            playVerbalFeedback(`Ini ${data.name}. Tekan Enter untuk memilih.`);
          });
          moneyButtonsContainer.appendChild(btn);
        });

        const firstMoneyBtn = moneyButtonsContainer.querySelector("button");
        if (firstMoneyBtn) firstMoneyBtn.focus();
      });

      const formatRupiah = (number) => {
        return new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
          minimumFractionDigits: 0,
        }).format(number);
      };

      const recalculatePrice = () => {
        itemPrice = basePrice * itemQuantity;
        updateDisplay();
      };

      const updateDisplay = () => {
        itemPriceDisplay.textContent = formatRupiah(itemPrice);
        paymentDisplay.textContent = formatRupiah(totalPaid);
        quantityDisplay.textContent = itemQuantity;

        // Kontrol tombol kuantitas
        btnQuantityMinus.disabled = itemQuantity <= 1;
        btnQuantityPlus.disabled = itemQuantity >= 99; // Batas maksimum 99

        messageBox.classList.add("hidden");
        btnPlayAudio.classList.add("hidden");
      };

      // --- GEMINI ITEM GENERATOR (diubah jadi lokal) ---
      async function startNewTransaction() {
        plusText.textContent = "Memuat...";
        plusLoading.classList.remove("hidden");
        btnPlus.disabled = true;

        try {
          const priceList = {
            "Ayam Goreng": 12000,
            Bakso: 10800,
            Batagor: 8500,
            "Bubur Ayam": 10000,
            Cilok: 5200,
            Cimol: 5400,
            Dimsum: 10900,
            Donat: 5500,
            "Es Buah": 8700,
            "Es Jeruk": 5600,
            "Es Krim": 6000,
            "Es Teh": 4000,
            "Es Teler": 10400,
            Jus: 7600,
            Kwetiau: 15700,
            Maklor: 5800,
            "Martabak Manis": 12700,
            "Martabak Telur": 15900,
            "Mie Ayam": 15000,
            Mineral: 3200,
            Nasgor: 15800,
            "Pecel Lele": 15000,
            "Risol Mayo": 6500,
            "Roti Bakar": 10500,
            Seblak: 8800,
            Somay: 8600,
            Soto: 12300,
            Takoyaki: 10700,
            "Telur Gulung": 3300,
            "Telur Puyuh": 4200,
          };
          const itemImages = {
            "Ayam Goreng": "img/menu/ayam_goreng.jpg",
            Bakso: "img/menu/bakso.jpeg",
            Batagor: "img/menu/batagor.jpg",
            "Bubur Ayam": "img/menu/bubur_ayam.jpeg",
            Cilok: "img/menu/cilok.jpeg",
            Cimol: "img/menu/cimol.jpeg",
            Dimsum: "img/menu/dimsum.jpeg",
            Donat: "img/menu/donat.jpeg",
            "Es Buah": "img/menu/es_buah.jpg",
            "Es Jeruk": "img/menu/es_jeruk.jpeg",
            "Es Krim": "img/menu/es_krim.jpeg",
            "Es Teh": "img/menu/es_teh.jpeg",
            "Es Teler": "img/menu/es_teler.jpeg",
            Jus: "img/menu/jus.jpeg",
            Kwetiau: "img/menu/kwetiau.jpeg",
            Maklor: "img/menu/maklor.jpeg",
            "Martabak Manis": "img/menu/martabak_manis.jpeg",
            "Martabak Telur": "img/menu/martabak_telur.jpeg",
            "Mie Ayam": "img/menu/mie_ayam.jpeg",
            Mineral: "img/menu/mineral.jpg",
            Nasgor: "img/menu/nasgor.jpeg",
            "Pecel Lele": "img/menu/pecel_lele.jpeg",
            "Risol Mayo": "img/menu/risol_mayo.jpeg",
            "Roti Bakar": "img/menu/roti_bakar.jpeg",
            Seblak: "img/menu/seblak.jpeg",
            Somay: "img/menu/somay.jpeg",
            Soto: "img/menu/soto.jpeg",
            Takoyaki: "img/menu/takoyaki.jpeg",
            "Telur Gulung": "img/menu/telur_gulung.jpeg",
            "Telur Puyuh": "img/menu/telur_puyuh.jpg",
          };
          // Generate item secara acak
          const sampleItems = [
            "Ayam Goreng",
            "Bakso",
            "Batagor",
            "Bubur Ayam",
            "Cilok",
            "Cimol",
            "Dimsum",
            "Donat",
            "Es Buah",
            "Es Jeruk",
            "Es Krim",
            "Es Teh",
            "Es Teler",
            "Jus",
            "Kwetiau",
            "Maklor",
            "Martabak Manis",
            "Martabak Telur",
            "Mie Ayam",
            "Mineral",
            "Nasgor",
            "Pecel Lele",
            "Risol Mayo",
            "Roti Bakar",
            "Seblak",
            "Somay",
            "Soto",
            "Takoyaki",
            "Telur Gulung",
            "Telur Puyuh",
          ];

          const randomName =
            sampleItems[Math.floor(Math.random() * sampleItems.length)];

          const randomPrice = priceList[randomName];
          const generatedItem = {
            itemName: randomName,
            price: randomPrice,
          };

          // Atur harga dasar dan kuantitas awal
          basePrice = generatedItem.price;
          itemQuantity = 1;
          totalPaid = 0;
          recalculatePrice(); // Hitung total harga dan update display

          // Update UI
          itemNameDisplay.textContent = generatedItem.itemName;
          // Update gambar di display
          itemGambarDisplay.innerHTML = `  <img src="${itemImages[randomName]}" class="w-full h-full object-contain p-1" />`;
          messageBox.className =
            "mt-6 p-4 rounded-lg text-center font-bold text-lg bg-green-100 text-green-700";
          messageBox.textContent = `Harga Baru: ${
            generatedItem.itemName
          } (${formatRupiah(basePrice)}/item). Ayo bayar!`;
          messageBox.classList.remove("hidden");
        } catch (error) {
          itemNameDisplay.textContent = "Gagal memuat item. Coba lagi.";
          basePrice = 15000;
          itemQuantity = 1;
          recalculatePrice();
          messageBox.textContent = `Gagal membuat item. Harga default: ${formatRupiah(
            basePrice
          )}/item.`;
        } finally {
          plusText.textContent = "Pilih Jajan ‚ú®";
          plusLoading.classList.add("hidden");
          btnPlus.disabled = false;

          // ‚û§ Tambahkan animasi tombol pop
          btnPlus.classList.add("clicked");
          setTimeout(() => {
            btnPlus.classList.remove("clicked");
          }, 150);
          // ‚úÖ Scroll ke bawah sampai header selesai
          scrollToAfterHeader();
        }
      }
      function scrollToAfterHeader() {
        const header = document.getElementById("headerScene");
        if (!header) return;

        const headerBottom = header.offsetTop + header.offsetHeight;

        window.scrollTo({
          top: headerBottom,
          behavior: "smooth",
        });
      }
      function scrollToAfterBayar() {
        const header = document.getElementById("btnNext");
        if (!header) return;

        const headerBottom = header.offsetTop + header.offsetHeight;

        window.scrollTo({
          top: headerBottom,
          behavior: "smooth",
        });
      }
      function scrollToTop() {
        window.scrollTo({
          top: 0,
          behavior: "smooth",
        });
      }
      function scrollToBottom() {
        window.scrollTo({
          top: document.body.scrollHeight,
          behavior: "smooth",
        });
      }
      function scrollToCart() {
        const cart = document.getElementById("cartDisplay"); // target elemen
        if (!cart) return;

        // Scroll ke posisi atas elemen
        window.scrollTo({
          top: cart.offsetTop,
          behavior: "smooth",
        });
      }

      // --- EVENT LISTENERS & UI GENERATION ---

      // Tombol Kuantiitas Plus
      btnQuantityPlus.addEventListener("click", () => {
        if (itemPrice === 0 || basePrice === 0) return;

        if (itemQuantity < 99) {
          itemQuantity++;
          recalculatePrice();
        }
      });

      // Tombol Kuantiitas Minus
      btnQuantityMinus.addEventListener("click", () => {
        if (itemPrice === 0 || basePrice === 0) return;

        if (itemQuantity > 1) {
          itemQuantity--;
          recalculatePrice();
        }
      });

      // Inisialisasi Tombol Uang (Generasi Visual Uang Nyata)
      denominations.forEach((value) => {
        const button = document.createElement("button");
        const data = heroData[value];
        const isCoin = data.shape === "coin";
        // Ukuran gambar
        const imgWidth = isCoin ? 120 : 200;
        const imgHeight = isCoin ? 120 : 110;

        // HTML gambar
        let imageHtml;

        if (isCoin) {
          // Gambar koin, bulat
          imageHtml = `
                    <img src="${data.img}"
                         alt="Koin ${formatRupiah(value)}"
                         style="width: ${imgWidth}px; height: ${imgHeight}px; border-radius: 50%; object-fit: contain; background:#fff;">
                  `;
        } else {
          // Gambar uang kertas, TANPA CROP
          imageHtml = `
                    <img src="${data.img}"
                         alt="Uang ${formatRupiah(value)}"
                         style="width: ${imgWidth}px; height: ${imgHeight}px; border-radius: 8px; object-fit: contain; background:#fff;">
                  `;
        }

        // Isi tombol
        button.innerHTML = `
                  ${imageHtml}
                  <span style="font-size: 0.7rem; margin-top: 4px; text-align: center; display:block;">
                    ${data.name}
                  </span>
                `;

        // Style tombol
        button.classList.add("money-btn");
        button.style.display = "flex";
        button.style.flexDirection = "column";
        button.style.alignItems = "center";
        button.style.justifyContent = "center";
        button.style.margin = "5px";
        button.style.padding = "5px";
        button.style.backgroundColor = "#fff";
        button.style.borderRadius = "10px";
        button.style.height = "160px";

        button.setAttribute("data-value", value);

        // Event klik
        button.addEventListener("click", () => {
          if (itemPrice === 0) {
            messageBox.className =
              "mt-6 p-4 rounded-lg text-center font-bold text-lg bg-yellow-100 text-yellow-700";
            messageBox.textContent =
              'Tekan "Pilih Jajan" dulu untuk memulai transaksi!';
            messageBox.classList.remove("hidden");
            return;
          }
          totalPaid += value;
          updateDisplay();
        });

        moneyButtonsContainer.appendChild(button);
      });
      // Tombol Minus (Kurang/Reset Pembayaran)
      btnMinus.addEventListener("click", () => {
        // Hentikan audio lain dulu
        stopCurrentAudio();

        totalPaid = 0;
        updateDisplay();

        const msg = "Pembayaran diulang. Silakan tekan tombol bayar lagi.";

        // Tampilkan pesan
        messageBox.className =
          "mt-6 p-4 rounded-lg text-center font-bold text-lg bg-red-100 text-red-700";
        messageBox.textContent = msg;
        messageBox.classList.remove("hidden");
        btnPlayAudio.classList.remove("hidden");

        // Reset tampilan harga
        paymentDisplay.textContent = "Rp 0";
        itemPriceDisplay.textContent = "Rp 0";

        // üîä Audio: "Pembayaran diulang"
        const audioReset = new Audio("audio/kasir_visual/ulang.mp3");
        audioReset.play();
        scrollToBottom();

        // üîä Setelah itu: "Silakan tekan tombol bayar lagi"
        audioReset.onended = () => {
          const audioAgain = new Audio("audio/kasir_audio/bayar.mp3");
          scrollToCart();
          audioAgain.play();
        };
      });

      // Tombol Plus (Tambah/Harga Baru)
      btnPlus.addEventListener("click", startNewTransaction);

      // Tombol Sama Dengan (Hitung Kembalian)
      btnEquals.addEventListener("click", () => {
        // Hentikan audio lain dulu
        stopCurrentAudio();
        const change = totalPaid - itemPrice;
        const currentItemPrice = itemPrice; // simpan snapshot
        const currentTotalPaid = totalPaid; // simpan snapshot
        let feedbackMessage = "";

        if (currentItemPrice === 0) {
          // ini belum ===========================================================
          // =============================================
          currentAudio = new Audio("audio/kasir_visual/hai.mp3");
          currentAudio.play();
          feedbackMessage =
            'Hai! Tekan "Pilih Jajan" dulu untuk memulai transaksi.';
          messageBox.className =
            "mt-6 p-4 rounded-lg text-center font-bold text-lg bg-yellow-100 text-yellow-700";
          scrollToTop();
          messageBox.innerHTML = feedbackMessage;

          // üîπ Scroll otomatis ke tombol Pilih Jajan
          const btnPilihJajan = document.getElementById("btnPilihJajan");
          if (btnPilihJajan) {
            btnPilihJajan.scrollIntoView({
              behavior: "smooth",
              block: "center",
            });
            btnPilihJajan.focus(); // optional, biar keyboard user langsung bisa tekan Enter/Space
          }
        } else if (currentTotalPaid === 0) {
          // Audio peringatan
          const audioLess = new Audio("audio/kasir_visual/blm_bayar.mp3");
          audioLess.play();

          // Pesan teks + style
          const feedbackMessage =
            "Ups, Kamu belum membayar! Coba masukkan uang yang tepat. Semangat!";
          messageBox.innerHTML = feedbackMessage;
          messageBox.className =
            "mt-6 p-4 rounded-lg text-center font-bold text-lg bg-red-100 text-red-700";

          // Scroll ke bawah supaya pesan terlihat
          scrollToAfterBayar();
        } else if (change < 0) {
          // Audio peringatan kurang uang
          const audioLess = new Audio("audio/kasir_visual/kurang.mp3");
          audioLess.play();

          // Pesan feedback
          const feedbackMessage = `Uangmu kurang ${formatRupiah(
            Math.abs(change)
          )}! Coba hitung lagi.`;

          // Buat HTML pecahan uang
          const uangPecahan = [
            100000, 50000, 20000, 10000, 5000, 2000, 1000, 500, 200, 100,
          ];
          let sisa = Math.abs(change);
          let gambarHTML = "<div class='flex flex-wrap justify-center mt-3'>";
          uangPecahan.forEach((nominal) => {
            let jumlah = Math.floor(sisa / nominal);
            sisa %= nominal;
            for (let i = 0; i < jumlah; i++) {
              gambarHTML += `<img src="img/${nominal}.png" class="w-26 h-24 m-1 rounded-sm shadow-md" />`;
            }
          });
          gambarHTML += "</div>";

          // Tampilkan pesan + gambar
          messageBox.innerHTML = feedbackMessage + gambarHTML;
          messageBox.className =
            "mt-6 p-4 rounded-lg text-center font-bold text-lg bg-red-100 text-red-700";
          scrollToBottom();

          audioLess.onended = () => {
            // TTS untuk jumlah kekurangan
            const ttsLess = new SpeechSynthesisUtterance(
              `${formatRupiah(Math.abs(change))}`
            );
            ttsLess.lang = "id-ID";

            ttsLess.onend = () => {
              // Audio terakhir: coba hitung lagi
              const audioRetry = new Audio(
                "audio/kasir_visual/hitung_lagi.mp3"
              );
              audioRetry.play();

              audioRetry.onended = () => {
                // Scroll baru dijalankan setelah audio terakhir selesai
                scrollToAfterBayar();
              };
            };

            speechSynthesis.speak(ttsLess);
          };
        } else {
          // 3Ô∏è‚É£ Transaksi berhasil (tampilkan teks + pecahan uang)
          let sisa = change;
          const uangPecahan = [
            100000, 50000, 20000, 10000, 5000, 2000, 1000, 500, 200, 100,
          ];
          let gambarHTML = `<div class='flex flex-wrap justify-center mt-3'>`;
          uangPecahan.forEach((nominal) => {
            let jumlah = Math.floor(sisa / nominal);
            sisa %= nominal;
            for (let i = 0; i < jumlah; i++) {
              gambarHTML += `<img src="img/${nominal}.png" class="w-26 h-24 m-1 rounded-sm shadow-md" />`;
            }
          });
          gambarHTML += "</div>";

          messageBox.innerHTML =
            `Yey! Transaksi berhasil! Total kembalianmu adalah ${formatRupiah(
              change
            )}.<br>Kamu hebat dalam menghitung!` + gambarHTML;
          messageBox.className =
            "mt-6 p-4 rounded-lg text-center font-bold text-lg bg-green-100 text-green-700";

          // 1Ô∏è‚É£ Audio pertama: "Yey! Transaksi berhasil!"
          const audio1 = new Audio("audio/kasir_visual/transaksi_berhasil.mp3");
          audio1.play();

          // 2Ô∏è‚É£ TTS untuk jumlah kembalian saja
          audio1.onended = () => {
            const ttsChange = new SpeechSynthesisUtterance(
              ` ${formatRupiah(change)}`
            );
            ttsChange.lang = "id-ID";

            ttsChange.onend = () => {
              // 3Ô∏è‚É£ Audio terakhir: "Kamu hebat dalam menghitung!"
              const audio2 = new Audio("audio/kasir_visual/apresiasi.mp3");
              audio2.play();
              audio2.onended = () => {
                scrollToTop(); // scroll baru jalan setelah audio terakhir
              };
            };

            speechSynthesis.speak(ttsChange);
          };

          resetCart();
          scrollToBottom();
        }

        messageBox.classList.remove("hidden");
        btnPlayAudio.classList.remove("hidden");

        // hentikan TTS lain
        window.speechSynthesis.cancel();

        window.speechSynthesis.cancel();
      });
      // Tombol Play Audio terpisah
      btnPlayAudio.addEventListener("click", () => {
        // Mainkan pesan terakhir yang ada di messageBox
        playVerbalFeedback(messageBox.textContent, "Puck");
      });
      // button back
      document.getElementById("btnBack").addEventListener("click", () => {
        // Ambil mode dari localStorage
        const mode = localStorage.getItem("gameMode") || "visual";
        window.location.href = `menu.html?mode=${mode}`;
      });

      // Inisialisasi awal saat halaman dimuat
      // Hapus ini
      // window.onload = startNewTransaction;

      // Ganti dengan inisialisasi awal
      window.onload = () => {
        // Reset state
        basePrice = 0;
        itemQuantity = 0;
        itemPrice = 0;
        totalPaid = 0;

        // Update tampilan
        itemNameDisplay.textContent = "Tekan 'Pilih Jajan' untuk memulai!";
        itemPriceDisplay.textContent = formatRupiah(0);
        paymentDisplay.textContent = formatRupiah(0);
        quantityDisplay.textContent = 0;

        // Sembunyikan elemen yang tidak perlu
        messageBox.classList.add("hidden");
        btnPlayAudio.classList.add("hidden");
        itemGambarDisplay.classList.remove("hidden");
      };

      const scrollTopBtn = document.getElementById("scrollTopBtn");

      // Munculkan tombol kalau sudah scroll 200px
      window.addEventListener("scroll", () => {
        if (window.scrollY > 200) {
          scrollTopBtn.style.display = "flex";
        } else {
          scrollTopBtn.style.display = "none";
        }
      });

      // Aksi saat tombol diklik
      scrollTopBtn.addEventListener("click", () => {
        window.scrollTo({
          top: 0,
          behavior: "smooth",
        });
      });

      window.addEventListener("load", () => {
        window.scrollTo({ top: 0, behavior: "instant" });
      });
      const btnNext = document.getElementById("btnNext");

      btnNext.addEventListener("click", () => {
        let total = 0;

        cart.forEach((item) => {
          total += item.price * item.qty;
        });

        itemPrice = total;
        itemPriceDisplay.textContent = `Rp ${total.toLocaleString("id-ID")}`;
        scrollToAfterBayar();
      });

      // ============== keranjang ==========================
      const btnAddToCart = document.getElementById("btnAddToCart");
      const cartList = document.getElementById("cartList");

      let cart = [];
      /* isi cart:[
                  { name: "Permen", price: 2000, qty: 2 },
                  { name: "Coklat", price: 5000, qty: 1 }]
                */

      function renderCart() {
        const cartList = document.getElementById("cartList");
        cartList.innerHTML = "";

        cart.forEach((item) => {
          const tr = document.createElement("tr");
          tr.className = "border-b last:border-0 hover:bg-gray-50";

          tr.innerHTML = `
            <td class="p-3 font-medium text-gray-800">${item.name}</td>
            <td class="p-3 text-center font-semibold">${item.qty}</td>
            <td class="p-3 text-right">
              Rp ${item.price.toLocaleString("id-ID")}
            </td>
            <td class="p-3 text-right font-bold text-green-600">
              Rp ${(item.price * item.qty).toLocaleString("id-ID")}
            </td>
          `;

          cartList.appendChild(tr);
        });

        updateCartTotal();
      }
      btnAddToCart.addEventListener("click", () => {
        if (
          !itemNameDisplay.textContent ||
          basePrice === 0 ||
          itemQuantity === 0
        ) {
          alert("Pilih item dan jumlah dulu ya üòä");
          return;
        }

        const itemName = itemNameDisplay.textContent.trim();

        const existingItem = cart.find((item) => item.name === itemName);

        if (existingItem) {
          // ‚úÖ Tambah qty (akumulasi)
          existingItem.qty += itemQuantity;
        } else {
          cart.push({
            name: itemName,
            price: basePrice,
            qty: itemQuantity,
          });
          scrollToCart();
        }

        renderCart();

        // üîÅ Reset quantity biar tidak ketumpuk
        itemNameDisplay.textContent = "Pilih Jajanan Baru";
        itemPriceDisplay.textContent = "Rp 0";
        quantityDisplay.textContent = "0";
        itemGambarDisplay.textContent = "";
        itemQuantity = 0; // ‚úÖ penting ini
        basePrice = 0;
        itemPrice = 0;
      });

      function resetCart() {
        cart = [];

        // Kosongkan UI keranjang
        const cartList = document.getElementById("cartList");
        cartList.innerHTML = "";

        // Reset quantity & item
        itemQuantity = 0;
        basePrice = 0;
        itemPrice = 0;
        totalPaid = 0;

        // Reset tampilan
        quantityDisplay.textContent = "0";
        itemNameDisplay.textContent = 'Tekan "Pilih Jajan"';
        itemPriceDisplay.textContent = "Rp 0";
        paymentDisplay.textContent = "Rp 0";

        // Reset gambar
        const imgBox = document.getElementById("itemGambarDisplay");
        imgBox.innerHTML = "";

        // Disable tombol qty
        btnQuantityPlus.disabled = true;
        btnQuantityMinus.disabled = true;
      }
      document.getElementById("btnNext").addEventListener("click", () => {
        if (totalPaid >= itemPrice) {
          resetCart();
        }
      });
      // pop total harga
      const totalSection = document.getElementById("cartTotalDisplay");
      const floatingTotal = document.getElementById("floatingTotal");
      const floatingTotalText = document.getElementById("floatingTotalText");

      window.addEventListener("scroll", () => {
        const rect = totalSection.getBoundingClientRect();

        // Kalau bagian total aslinya sudah tidak kelihatan
        if (rect.bottom < 0) {
          floatingTotal.classList.remove("hidden");
        } else {
          floatingTotal.classList.add("hidden");
        }
      });
      // ===== POPUP TOTAL HARGA SAAT TIDAK TERLIHAT =====
      const itemPriceEl = document.getElementById("itemPriceDisplay");

      // Update teks popup
      function updateFloatingTotal() {
        floatingTotalText.textContent = itemPriceDisplay.textContent;
      }

      // Cek apakah total asli masih terlihat di layar
      function isElementInViewport(el) {
        const rect = el.getBoundingClientRect();
        return (
          rect.top >= 0 &&
          rect.bottom <=
            (window.innerHeight || document.documentElement.clientHeight)
        );
      }

      // Show / hide popup saat scroll
      window.addEventListener("scroll", () => {
        if (!isElementInViewport(itemPriceEl) && itemPrice > 0) {
          floatingTotal.classList.remove("hidden");
          updateFloatingTotal();
        } else {
          floatingTotal.classList.add("hidden");
        }
      });

      // Juga update saat harga berubah
      function updateTotalPriceDisplay() {
        itemPriceDisplay.textContent = `Rp ${itemPrice.toLocaleString(
          "id-ID"
        )}`;
        updateFloatingTotal();
      }

      // stop audio
      let currentAudio = null;
      function stopCurrentAudio() {
        if (currentAudio) {
          currentAudio.pause();
          currentAudio.currentTime = 0;
          currentAudio = null;
        }
      }
    </script>
  </body>
</html>
