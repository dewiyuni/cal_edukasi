<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jodohkan Gambar</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      :root {
        --primary-bg: #fef3c7;
        --header-bg: #ea580c;
        --accent-green: #38a169;
        --accent-yellow: #f6ad55;
        --display-blue: #3182ce;
        --font-inter: "Inter", sans-serif;
      }

      body {
        font-family: "Poppins", sans-serif;
        background: #fff7ed;
        margin: 5px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
      }

      .container {
        width: 100%;
        max-width: 1100px;
        margin: 0 auto;
        text-align: center;
        padding: 10px 20px;
        box-sizing: border-box;
      }

      .header-scene {
        position: relative;
        overflow: hidden;
        height: 120px;
        max-width: 900px;
        margin: 0 auto;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        text-align: center;
        color: white;
        padding: 20px;
      }

      .moving-bg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("img/bg header.png");
        background-repeat: repeat-x;
        background-size: 100%;
        background-position: 0 0;
        animation: moveBackground 25s linear infinite;
        z-index: 0;
      }

      @keyframes moveBackground {
        0% {
          background-position: 0 0;
        }
        100% {
          background-position: -1000px 0;
        }
      }

      main {
        background: white;
        padding: 20px;
        border-radius: 0 0 20px 20px;
        box-shadow: 1px 1px #fabb58;
        width: 100%;
        max-width: 940px;
        margin: 0 auto;
        box-sizing: border-box;
        position: relative;
      }

      .cashier-img {
        position: relative;
        z-index: 1;
        width: 120px;
        height: 120px;
        margin: 0 auto;
        background-color: #ff7b00;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        border: 4px solid #ff7b00;
      }

      .cashier-text {
        color: white;
        font-size: 18px;
        font-weight: bold;
        text-align: center;
        line-height: 1.2;
      }

      .title {
        font-size: 28px;
        font-weight: 800;
        color: #ff7b00;
        margin-bottom: 10px;
      }

      /* --- INFO BOX AWAL --- */
      .info-box {
        display: flex;
        justify-content: space-between;
        padding: 12px 15px;
        background: white;
        border: 3px solid #ffae42;
        border-radius: 15px;
        margin: 0 auto 20px;
        width: 85%;
        font-size: 18px;
        box-shadow: 4px 4px 0 #ffa726;
      }

      /* --- FLOATING INFO --- */
      #floatingInfo {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.8);
        padding: 8px 12px;
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
        gap: 15px;
        font-size: 14px;
        box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      #floatingInfo.visible {
        opacity: 1;
      }

      .start-container button {
        padding: 12px 18px;
        font-size: 18px;
        font-weight: bold;
        border-radius: 15px;
        border: 3px solid #ff9800;
        background: #fff3cd;
        box-shadow: 4px 4px 0 #ffa726;
        cursor: pointer;
        margin-bottom: 20px;
      }

      .start-container button:hover {
        background: #ffe28a;
        transform: scale(1.05);
        transition: 0.2s;
      }

      #gameArea {
        display: none;
        width: 100%;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 15px;
        margin-top: 20px;
        width: 100%;
      }

      .choice {
        background: white;
        border: 3px solid #ffa726;
        border-radius: 15px;
        padding: 10px;
        cursor: pointer;
        box-shadow: 4px 4px 0 #ffb74d;
        transition: 0.15s;
      }

      .choice:hover {
        transform: scale(1.07);
      }

      .choice img {
        width: 100%;
        height: 140px;
        object-fit: contain;
        margin: 20px auto 0 auto;
      }
      .choice:focus {
        outline: 4px solid blue;
      }

      #targetImage img {
        width: 40%;
        max-width: 300px;
        height: auto;
        object-fit: contain;
        display: block;
        margin: 12px auto;
        box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.3);
        border-radius: 10px;
      }
      .correct {
        border-color: #4ade80 !important;
        box-shadow: 4px 4px 0 #22c55e !important;
      }

      .wrong {
        animation: shake 0.3s;
        border-color: #ef4444 !important;
        box-shadow: 4px 4px 0 #dc2626 !important;
      }

      @keyframes shake {
        0% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        50% {
          transform: translateX(5px);
        }
        75% {
          transform: translateX(-5px);
        }
        100% {
          transform: translateX(0);
        }
      }

      #feedback {
        font-size: 24px;
        font-weight: bold;
        margin-top: 15px;
        min-height: 40px;
        line-height: 40px;
        padding: 5px 10px;
        border-radius: 10px;
        transition: all 0.3s ease;
        opacity: 0;
        transform: scale(0.8);
      }

      #feedback.correct {
        color: #22c55e;
        background: #d1fae5;
        border: 2px solid #22c55e;
        opacity: 1;
        transform: scale(1);
      }

      #feedback.wrong {
        color: #ef4444;
        background: #fee2e2;
        border: 2px solid #ef4444;
        opacity: 1;
        transform: scale(1);
        animation: shake 0.3s;
      }
      .back-btn {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.85);
        color: #ea580c;
        font-weight: bold;
        padding: 8px 14px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        border: none;
        cursor: pointer;
        z-index: 9999;
        transition: 0.2s;
      }
      .back-btn:hover {
        background: white;
        transform: scale(1.05);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- button back -->
      <button id="btnBack" class="back-btn">
        <i class="fas fa-arrow-left"></i>
      </button>

      <!-- Header -->
      <header class="header-scene">
        <div class="moving-bg"></div>
        <div class="moving-bg"></div>
        <div class="cashier-img">
          <span class="cashier-text">Uang<br />Match</span>
        </div>
      </header>

      <main>
        <h1 class="title">Menjodohkan Gambar üç±‚ú®</h1>

        <!-- INFO BOX AWAL -->
        <div class="info-box" id="judulGame">
          <p>Skor: <span id="score">0</span></p>
          <p>Nyawa: <span id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></p>
          <p>Level: <span id="level">1</span></p>
        </div>

        <!-- FLOATING INFO -->
        <div id="floatingInfo">
          <p>Skor: <span id="scoreFloat">0</span></p>
          <p>Nyawa: <span id="livesFloat">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></p>
          <p>Level: <span id="levelFloat">1</span></p>
        </div>

        <div class="start-container">
          <button id="startBtn" tabindex="0" aria-label="Mulai Permainan">
            Mulai Permainan
          </button>
        </div>

        <div id="gameArea">
          <h2 id="instruction">Cari gambar dengan harga yang sama</h2>
          <div id="targetImage"></div>
          <div id="gridContainer" class="grid"></div>
        </div>
        <div id="finishScreen" style="display: none"></div>

        <div id="feedback"></div>
        <button
          id="restartBtn"
          style="
            display: none;
            margin-top: 20px;
            padding: 12px 20px;
            font-size: 18px;
            border-radius: 12px;
            background: #fb923c;
            color: white;
            border: none;
            cursor: pointer;
          "
        >
          üîÑ Restart Game
        </button>

        <p id="sr-only" style="position: absolute; left: -9999px"></p>
      </main>
    </div>

    <script>
      let allowVoice = true;
      let finishedGame = false;
      let totalCorrect = 0;
      let lastQuestion = null;

      // ================== MODE & SPEECH ==================

      function isVisualMode() {
        return localStorage.getItem("gameMode") === "visual";
      }
      function stopSpeak() {
        if ("speechSynthesis" in window) {
          window.speechSynthesis.cancel();
        }
        isSpeaking = false;
      }

      let isSpeaking = false;

      function speak(text, onEnd = null) {
        if (!("speechSynthesis" in window)) return;
        if (!allowVoice) return; // kalau voice dimatikan, stop

        stopSpeak(); // ‚úÖ HENTIKAN SUARA SEBELUMNYA

        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = "id-ID";
        msg.rate = 0.9;
        msg.pitch = 1;

        isSpeaking = true;

        msg.onend = () => {
          isSpeaking = false;
          if (onEnd) onEnd();
        };

        window.speechSynthesis.speak(msg);
      }

      // ================== KEYBOARD ==================

      document.addEventListener("keydown", (e) => {
        if (!isVisualMode() || !gameRunning) return;

        const choices = document.querySelectorAll(".choice");

        if (e.key >= "1" && e.key <= String(currentChoices.length)) {
          const index = parseInt(e.key) - 1;
          if (choices[index]) {
            choices[index].click();
          } else {
            speak("Pilihan tidak tersedia");
          }
        }
      });

      // ================== DATA ==================

      const moneyImages = {
        1000: "img/1000.png",
        2000: "img/2000.png",
        5000: "img/5000.png",
        10000: "img/10000.png",
        20000: "img/20000.png",
        50000: "img/50000.png",
        100000: "img/100000.png",
      };

      const itemImages = {
        1000: [
          { src: "img/permen.jpg", label: "Permen" },
          { src: "img/ballon.png", label: "Balon" },
          { src: "img/pensil-mini.png", label: "Pensil Mini" },
        ],

        2000: [
          { src: "img/bengbeng.jpeg", label: "Beng-beng" },
          { src: "img/nabati.jpeg", label: "Nabati" },
          { src: "img/tango.jpeg", label: "Tango" },
          { src: "img/penghapus.jpeg", label: "Penghapus" },
        ],

        5000: [
          { src: "img/coklat.png", label: "Coklat" },
          { src: "img/chikitwist.jpeg", label: "Chiki Twist" },
          { src: "img/ultramilk.jpeg", label: "Ultra Milk" },
          { src: "img/ganci.jpeg", label: "Gantungan Kunci" },
          { src: "img/gelang.png", label: "Gelang" },
          { src: "img/jepit.jpg", label: "Jepit Rambut" },
        ],

        10000: [
          { src: "img/cake.jpg", label: "Kue" },
          { src: "img/frenchfries.jpeg", label: "Kentang Goreng" },
          { src: "img/nescafe.jpeg", label: "Nescafe" },
          { src: "img/kaoskaki.jpeg", label: "Kaos Kaki" },
        ],

        20000: [
          { src: "img/botol.jpeg", label: "Botol Minum" },
          { src: "img/topi.jpg", label: "Topi" },
          { src: "img/sendal.jpeg", label: "Sandal" },
        ],

        50000: [
          { src: "img/boneka.png", label: "Boneka" },
          { src: "img/jashujan.jpeg", label: "Jas Hujan" },
          { src: "img/tas.png", label: "Tas" },
        ],

        100000: [
          { src: "img/mobil.jpeg", label: "Mobil Mainan" },
          { src: "img/sepatu.jpeg", label: "Sepatu" },
        ],
      };

      // ================== GAME STATE ==================

      let score = 0,
        correctCount = 0,
        level = 1,
        maxLevel = 3,
        lives = 3,
        gameRunning = false,
        gameCompleted = false;

      const scoreDisplay = document.getElementById("score");
      const livesDisplay = document.getElementById("lives");
      const livesFloatDisplay = document.getElementById("livesFloat");
      const scoreFloatDisplay = document.getElementById("scoreFloat");
      const levelFloatDisplay = document.getElementById("levelFloat");
      const levelDisplay = document.getElementById("level");
      const startBtn = document.getElementById("startBtn");
      const targetImage = document.getElementById("targetImage");
      const gridContainer = document.getElementById("gridContainer");
      const gameArea = document.getElementById("gameArea");
      const feedbackDisplay = document.getElementById("feedback");
      const restartBtn = document.getElementById("restartBtn");

      // =========audio global ================
      let currentAudio = null;

      function playAudio(src) {
        return new Promise((resolve) => {
          // stop audio sebelumnya
          if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
          }

          const audio = new Audio(src);
          currentAudio = audio;
          audio.volume = 1;

          audio.onended = () => {
            resolve(); // lanjut ke audio berikutnya
          };

          audio.onerror = () => {
            resolve(); // kalau error, tetap lanjut
          };

          audio.play().catch(() => resolve());
        });
      }

      // ================== START ==================

      startBtn.addEventListener("click", async () => {
        stopAllSound();
        stopSpeak();
        allowVoice = true;

        startBtn.style.display = "none";
        gameArea.style.display = "block";
        startGame();

        setTimeout(() => {
          scrollToAfterHeader();
        }, 200);

        if (isVisualMode()) {
          (async () => {
            // 1. Audio: "Mulai"
            await playAudio("audio/match_visual/mulai.mp3");

            // 2. Audio: "Cari barang dengan harga"
            await playAudio("audio/match_audio/cari_barang.mp3");

            // 3. TTS: angka rupiahnya
            speak(`${lastQuestion.correctKey} rupiah`);
          })();
        }
      });

      function startGame() {
        score = 0;
        level = 1;
        gameRunning = true;
        totalCorrect = 0;
        allowVoice = true;
        finishedGame = false;
        lastQuestion = null;

        updateDisplay();
        loadRound(false, true);
      }

      function updateDisplay() {
        scoreDisplay.textContent = score;
        levelDisplay.textContent = level;

        scoreFloatDisplay.textContent = score;
        levelFloatDisplay.textContent = level;

        livesDisplay.textContent = "‚ù§Ô∏è".repeat(lives);
        livesFloatDisplay.textContent = "‚ù§Ô∏è".repeat(lives);
      }

      // ================== GAME ROUND ==================

      let currentChoices = [];
      let currentAnswer = "";

      async function loadRound(repeat = false, isFirstRound = false) {
        if (!gameRunning || finishedGame) return;

        stopSpeak();
        allowVoice = true;

        if (!repeat) {
          const keys = Object.keys(moneyImages);
          const correctKey = keys[Math.floor(Math.random() * keys.length)];
          currentAnswer = correctKey;

          const otherKeys = keys.filter((k) => k !== correctKey);
          const choicesKeys = otherKeys
            .sort(() => Math.random() - 0.5)
            .slice(0, 2);

          choicesKeys.push(correctKey);
          choicesKeys.sort(() => Math.random() - 0.5);

          lastQuestion = { correctKey, choicesKeys };
          currentChoices = choicesKeys; // ‚úÖ untuk keyboard
        }

        const { correctKey, choicesKeys } = lastQuestion;

        targetImage.innerHTML = `<img src="${moneyImages[correctKey]}" alt="uang ${correctKey}" />`;
        gridContainer.innerHTML = "";

        choicesKeys.forEach((key) => {
          const div = document.createElement("div");
          div.className = "choice";
          const items = itemImages[key];
          const randomItem = items[Math.floor(Math.random() * items.length)];
          div.innerHTML = `
      <img src="${randomItem.src}" alt="${randomItem.label}">
      <p style="margin-top:8px; font-weight:bold; font-size:16px; color:#ff7b00;">
        Rp ${Number(key).toLocaleString()}
      </p>
    `;
          div.addEventListener("click", () =>
            handleChoice(div, key, correctKey)
          );
          gridContainer.appendChild(div);
        });

        // ‚úÖ TTS dengan await agar soal berikutnya terdengar
        if (!isFirstRound) {
          if (isVisualMode() && allowVoice && !finishedGame) {
            await playAudio("audio/match_audio/cari_barang.mp3");
            speak(`${correctKey} rupiah`);
          }
        }
      }

      // ================== HANDLE CHOICE ==================
      function handleChoice(div, selected, correct) {
        if (!gameRunning) return;

        // STOP semua suara saat klik
        allowVoice = false;
        stopSpeak();

        if (selected === correct) {
          div.classList.add("correct");
          feedbackDisplay.textContent = "‚úÖ Benar!";
          feedbackDisplay.className = "correct";

          score += 1;
          totalCorrect++;
          checkLevelUp();

          if (isVisualMode()) {
            stopSpeak();

            (async () => {
              await playAudio("audio/match_audio/benar.mp3");

              // setelah audio selesai
              if (!finishedGame) {
                feedbackDisplay.textContent = "";
                feedbackDisplay.className = "";
                loadRound(false);
              }
            })();
          } else {
            // mode non-visual (tanpa audio)
            if (!finishedGame) {
              setTimeout(() => {
                feedbackDisplay.textContent = "";
                feedbackDisplay.className = "";
                loadRound(false);
              }, 800);
            }
          }
        } else {
          div.classList.add("wrong");
          feedbackDisplay.textContent = "‚ùå Salah";
          feedbackDisplay.className = "wrong";

          if (isVisualMode()) {
            stopSpeak();
            playAudio("audio/match_audio/salah.mp3");
          }
          // ‚úÖ Kurangi nyawa jika salah
          lives--;
          updateDisplay();

          // ‚ùå Kalau nyawa habis ‚Üí game over
          if (lives <= 0) {
            finishedGame = true;
            gameRunning = false;
            feedbackDisplay.textContent = "üíÄ Permainan berakhir!";
            showFinishScreen(false); // <- ini penting
            return;
          }

          // ‚ùå SALAH ‚Üí ULANG SOAL YANG SAMA
          setTimeout(() => {
            feedbackDisplay.textContent = "";
            feedbackDisplay.className = "";
            loadRound(true); // ulang soal
          }, 1200);
        }
      }
      function checkLevelUp() {
        if (level === 1 && totalCorrect >= 3) {
          level = 2;
        } else if (level === 2 && totalCorrect >= 5) {
          level = 3;
        } else if (level === 3 && totalCorrect >= 7) {
          finishedGame = true;
          gameRunning = false;
          stopSpeak();
          showFinishScreen();
        }
        updateDisplay();
      }

      // palyaudiosafe
      async function playAudioSafe(src) {
        // stop audio sebelumnya
        if (currentAudio) {
          currentAudio.pause();
          currentAudio.currentTime = 0;
        }

        // jeda kecil agar browser siap
        await new Promise((r) => setTimeout(r, 30));

        // play audio baru
        return playAudio(src);
      }

      async function showFinishScreen(win = true) {
        gameRunning = false;

        if (win) {
          gameArea.innerHTML = `
      <div style="text-align:center; padding:20px;">
        <h2>üéâ Selamat!</h2>
        <p>Anda telah menyelesaikan level tertinggi</p>
        <button id="restartBtn" style="
          margin-top:15px;
          padding:12px 24px;
          font-size:18px;
          border-radius:12px;
          background:#ea580c;
          color:white;
          border:none;
        ">Restart Game</button>
      </div>
    `;
          stopAllSound();
          allowVoice = false;
          stopSpeak();

          if (isVisualMode()) {
            // ‚ö° langsung await, jangan pakai IIFE
            await playAudio(""),
              await playAudio("audio/match_visual/selamat.mp3");
            await playAudio("audio/match_visual/restart.mp3");
          }
        } else {
          gameArea.innerHTML = `
      <div style="text-align:center; padding:20px;">
        <h2>üíÄ Game Over</h2>
        <p>Nyawa habis, coba lagi ya!</p>
        <button id="restartBtn" style="
          margin-top:15px;
          padding:12px 24px;
          font-size:18px;
          border-radius:12px;
          background:#ea580c;
          color:white;
          border:none;
        ">Restart Game</button>
      </div>
    `;
          stopAllSound();
          allowVoice = false;
          stopSpeak();

          if (isVisualMode()) {
            await playAudio("audio/match_visual/gagal.mp3");
            await playAudio("audio/match_visual/restart.mp3");
          }
        }

        document.getElementById("restartBtn").addEventListener("click", () => {
          location.reload();
        });
      }

      // ================== BACK BUTTON ==================
      document.getElementById("btnBack").addEventListener("click", () => {
        // Ambil mode dari localStorage
        const mode = localStorage.getItem("gameMode") || "visual";
        window.location.href = `menu.html?mode=${mode}`;
      });

      restartBtn.addEventListener("click", () => {
        score = 0;
        correctCount = 0;
        level = 1;
        lives = 3;
        gameRunning = true;
        gameCompleted = false; // ‚úÖ reset status

        feedbackDisplay.textContent = "";
        feedbackDisplay.className = "";

        restartBtn.style.display = "none";
        document.getElementById("gameArea").style.display = "block";
        startBtn.style.display = "none";

        updateDisplay();
        loadRound();
      });

      // restart game
      document.addEventListener("keydown", (e) => {
        if (!gameCompleted) return;

        // Tekan R untuk restart
        if (e.key.toLowerCase() === "r") {
          restartBtn.click();
        }
      });
      // audio refresh
      window.addEventListener("beforeunload", () => {
        if ("speechSynthesis" in window) window.speechSynthesis.cancel();
      });

      window.addEventListener("load", () => {
        window.scrollTo({ top: 0, behavior: "instant" });
      });

      function stopAllSound() {
        window.speechSynthesis.cancel();

        if (currentAudio) {
          currentAudio.pause();
          currentAudio.currentTime = 0;
          currentAudio = null;
        }
      }

      // scrolltoafterheader
      function scrollToAfterHeader() {
        const target = document.getElementById("instruction");
        if (!target) return;

        const y = target.getBoundingClientRect().top + window.scrollY - 20;

        window.scrollTo({
          top: y,
          behavior: "smooth",
        });
      }
    </script>
  </body>
</html>
